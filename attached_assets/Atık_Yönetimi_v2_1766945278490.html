<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS - Stratejik Atık Yönetim Merkezi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animation Utilities */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';

        const { 
            QrCode, Scale, BarChart3, Activity, LogOut, MapPin, Printer, 
            CheckCircle2, AlertTriangle, Syringe, Trash2, Zap, Building2, 
            ArrowLeft, ScanLine, Save, Plus, ArrowRight, Keyboard, RefreshCcw, 
            PieChart, LayoutDashboard, Filter, Microscope, TrendingUp, TrendingDown, 
            Database, Loader2, GitCompare, AlertOctagon, Target, Minus, Coins, 
            Clock, Banknote, Wallet, Globe, Users, UserCircle2, ChevronRight, 
            Building, Trophy, MoreHorizontal, Camera, Check, X, SlidersHorizontal,
            ArrowUpRight, ClipboardList, Siren, Settings, Edit3, Save: SaveIcon,
            Briefcase, Settings2, Info, ChevronDown, ChevronUp, Calendar, AlertCircle, FileWarning,
            AlignLeft
        } = LucideIcons;

        // --- 1. SABİTLER ---
        const WASTE_TYPES = [
            { id: 'medical', label: 'Tıbbi Atık', color: 'bg-rose-600', text: 'text-rose-500', hex: '#e11d48', icon: Syringe, costPerKg: 15.0 }, 
            { id: 'hazardous', label: 'Tehlikeli Atık', color: 'bg-amber-500', text: 'text-amber-500', hex: '#f59e0b', icon: Zap, costPerKg: 25.0 }, 
            { id: 'domestic', label: 'Evsel Atık', color: 'bg-slate-500', text: 'text-slate-400', hex: '#64748b', icon: Trash2, costPerKg: 2.0 }, 
            { id: 'recycle', label: 'Geri Dönüşüm', color: 'bg-cyan-500', text: 'text-cyan-500', hex: '#06b6d4', icon: Activity, costPerKg: -1.0 }, 
        ];

        const HOSPITALS = [
            { id: 'H1', name: 'Hastane 1 (Anadolu)', color: '#3b82f6', icon: 'H1' }, 
            { id: 'H2', name: 'Hastane 2 (Avrupa)', color: '#8b5cf6', icon: 'H2' }, 
            { id: 'H3', name: 'Hastane 3 (Merkez)', color: '#10b981', icon: 'H3' }, 
        ];

        const LOCATION_CATEGORIES = [
            { id: 'icu', label: 'Yoğun Bakım', unit: 'Yatış Gün', wasteFactorRef: 2.5, kpiLabel: 'kg / Yatış Günü' }, 
            { id: 'service', label: 'Hasta Servisi', unit: 'Yatış Gün', wasteFactorRef: 1.2, kpiLabel: 'kg / Yatış Günü' },
            { id: 'or', label: 'Ameliyathane', unit: 'Ameliyat', wasteFactorRef: 6.0, kpiLabel: 'kg / Ameliyat' },
            { id: 'polyclinic', label: 'Poliklinik', unit: 'Protokol', wasteFactorRef: 0.3, kpiLabel: 'kg / Protokol' },
            { id: 'office', label: 'İdari Ofis', unit: 'Sabit', wasteFactorRef: 0.1, kpiLabel: 'kg / Personel' },
            { id: 'other', label: 'Diğer / Tanımsız', unit: 'Sabit', wasteFactorRef: 1.0, kpiLabel: 'kg / Birim' }
        ];

        const STAFF_MEMBERS = [
            { id: 'STF-001', name: 'Ahmet Yılmaz', shift: '08:00-16:00' },
            { id: 'STF-002', name: 'Ayşe Demir', shift: '08:00-16:00' },
            { id: 'STF-003', name: 'Mehmet Öztürk', shift: '16:00-24:00' },
            { id: 'STF-004', name: 'Zeynep Kaya', shift: '16:00-24:00' },
            { id: 'STF-005', name: 'Caner Erkin', shift: '00:00-08:00' },
        ];

        const HOSPITAL_MANAGERS = [
            { id: 'MGR-H1', name: 'Dr. Ali Veli (Başhekim Yard.)', hospitalId: 'H1' },
            { id: 'MGR-H2', name: 'Zeynep Yılmaz (İşletme Md.)', hospitalId: 'H2' },
            { id: 'MGR-H3', name: 'Kemal Sunal (Tesis Md.)', hospitalId: 'H3' },
        ];

        const DEFAULT_LOCATIONS = [
            { name: 'AMELIYATHANE-ODA1', category: 'or', customLabel: 'Ana Bina 1. Kat' },
            { name: 'AMELIYATHANE-ODA2', category: 'or', customLabel: 'Ana Bina 1. Kat' },
            { name: 'ACIL-TRIYAJ', category: 'polyclinic', customLabel: 'Acil Girişi' }, 
            { name: 'ACIL-MUDAHALE', category: 'polyclinic', customLabel: 'Kırmızı Alan' },
            { name: 'LAB-BIYOKIMYA', category: 'other', customLabel: 'Zemin Kat Laboratuvar' }, 
            { name: 'POLIKLINIK-KBB', category: 'polyclinic', customLabel: 'Poliklinik Blok B' }, 
            { name: 'YOGUNBAKIM-YB1', category: 'icu', customLabel: 'Cerrahi Yoğun Bakım' },
            { name: 'STERILIZASYON-1', category: 'other', customLabel: '-2. Kat' }, 
            { name: 'OFIS-IDARI', category: 'office', customLabel: 'Başhekimlik Katı' },
            { name: 'SERVIS-DAHILIYE-1', category: 'service', customLabel: '3. Kat Yataklı Servis' }
        ];

        // --- 2. MOCK DATABASE SERVİSİ ---
        const STORAGE_KEY = 'wms_mock_db_v14'; 

        const MockDB = {
            getData: () => {
                const data = localStorage.getItem(STORAGE_KEY);
                const defaultData = { 
                    records: [], 
                    issues: [], 
                    settings: {
                        locationMap: DEFAULT_LOCATIONS,
                        coefficients: {
                            'H1': { icu: 450, service: 1200, or: 180, polyclinic: 5000, office: 50, other: 1 },
                            'H2': { icu: 300, service: 900, or: 120, polyclinic: 3500, office: 40, other: 1 },
                            'H3': { icu: 600, service: 1500, or: 250, polyclinic: 6000, office: 80, other: 1 }
                        }
                    }
                };
                return data ? { ...defaultData, ...JSON.parse(data) } : defaultData;
            },
            saveData: (data) => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                window.dispatchEvent(new Event('db-change'));
            },
            getRecords: () => {
                return MockDB.getData().records;
            },
            addRecord: (record) => {
                const db = MockDB.getData();
                const newRecord = { 
                    ...record, 
                    id: `doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
                    timestampDate: new Date().toISOString(), 
                    weighedAt: record.weighedAt ? new Date().toISOString() : null
                };
                db.records.unshift(newRecord); 
                MockDB.saveData(db);
                return newRecord;
            },
            addIssue: (issue) => {
                const db = MockDB.getData();
                const newIssue = {
                    ...issue,
                    id: `issue_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,
                    timestamp: new Date().toISOString()
                };
                db.issues.unshift(newIssue);
                MockDB.saveData(db);
                return newIssue;
            },
            updateRecord: (docId, updates) => {
                const db = MockDB.getData();
                db.records = db.records.map(r => r.id === docId ? { 
                    ...r, ...updates, weighedAt: updates.weighedAt ? updates.weighedAt.toISOString() : r.weighedAt
                } : r);
                MockDB.saveData(db);
            },
            updateSettings: (newSettings) => {
                const db = MockDB.getData();
                db.settings = { ...db.settings, ...newSettings };
                MockDB.saveData(db);
            },
            seedData: (newRecords) => {
                const db = MockDB.getData();
                const processed = newRecords.map(r => ({
                    ...r,
                    id: `seed_${Math.random().toString(36).substr(2,9)}`,
                    timestampDate: r.timestamp.toISOString(),
                    weighedAt: r.weighedAt ? r.weighedAt.toISOString() : null
                }));
                db.records = [...processed, ...db.records];
                MockDB.saveData(db);
            }
        };

        // --- 3. ATOMİK BİLEŞENLER ---
        const SimpleDonutChart = ({ data }) => {
            if (!data || !Array.isArray(data)) return null;
            let accumulatedAngle = 0;
            const total = data.reduce((sum, item) => sum + (item.value || 0), 0);
            if (total === 0) return <div className="h-40 flex items-center justify-center text-slate-500 text-xs font-mono border-2 border-dashed border-slate-700 rounded-full w-40 h-40 mx-auto opacity-50">VERİ YOK</div>;
            return (
                <div className="relative w-56 h-56 mx-auto group">
                    <div className="absolute inset-4 bg-blue-500/5 rounded-full blur-2xl group-hover:bg-blue-500/10 transition-all duration-700"></div>
                    <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full drop-shadow-2xl relative z-10">
                        <circle cx="50" cy="50" r="40" fill="transparent" stroke="#0f172a" strokeWidth="8" />
                        {data.map((item, index) => {
                            const val = item.value || 0;
                            const percentage = val / total;
                            const angle = percentage * 360;
                            if (angle <= 0) return null;
                            const largeArcFlag = angle > 180 ? 1 : 0;
                            const x1 = 50 + 40 * Math.cos((accumulatedAngle * Math.PI) / 180);
                            const y1 = 50 + 40 * Math.sin((accumulatedAngle * Math.PI) / 180);
                            const x2 = 50 + 40 * Math.cos(((accumulatedAngle + angle) * Math.PI) / 180);
                            const y2 = 50 + 40 * Math.sin(((accumulatedAngle + angle) * Math.PI) / 180);
                            const pathData = total === val ? `M 50 10 a 40 40 0 0 1 0 80 a 40 40 0 0 1 0 -80` : `M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                            accumulatedAngle += angle;
                            return <path key={index} d={pathData} fill={item.hex} stroke="#1e293b" strokeWidth="2" className="hover:opacity-100 opacity-90 transition-all duration-300 cursor-pointer hover:scale-105 transform origin-center" />;
                        })}
                        <circle cx="50" cy="50" r="32" fill="#1e293b" />
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-20">
                        <span className="text-3xl font-bold text-white tracking-tighter drop-shadow-md">{total.toFixed(0)}</span>
                        <span className="text-[10px] text-slate-400 uppercase font-bold tracking-widest">kg Toplam</span>
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data, maxVal }) => {
            if (!data || !Array.isArray(data)) return null;
            return (
                <div className="h-40 flex items-end justify-around gap-2 px-2 border-b border-slate-700 pb-1 w-full">
                    {data.map((item, idx) => {
                        const val = item.value || 0;
                        const height = maxVal > 0 ? (val / maxVal) * 100 : 0;
                        return (
                            <div key={idx} className="flex flex-col items-center gap-1 flex-1 group w-full">
                                <div className="text-[10px] font-bold text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity mb-1">{val.toFixed(1)}</div>
                                <div className={`w-full max-w-[40px] rounded-t-sm transition-all duration-500 ${item.color || 'bg-blue-500'} hover:opacity-80 relative group-hover:shadow-[0_0_10px_rgba(59,130,246,0.5)]`} style={{ height: `${Math.max(height, 2)}%` }}></div>
                                <div className="text-[9px] text-slate-400 truncate w-full text-center mt-1 px-0.5">{item.label}</div>
                            </div>
                        )
                    })}
                    {data.length === 0 && <div className="text-xs text-slate-500 w-full text-center">Veri Yok</div>}
                </div>
            );
        };

        // --- 4. MOLEKÜLER BİLEŞENLER ---
        const RiskMatrix = ({ data, hospitals }) => {
            if (!data || data.length === 0) return <div className="flex items-center justify-center h-full text-slate-500 text-xs">Veri Bekleniyor...</div>;
            const maxVolume = Math.max(...data.map(d => d.total), 10);
            return (
                <div className="relative w-full h-80 bg-slate-800 border border-slate-700 rounded-lg p-4 overflow-hidden shrink-0">
                    <div className="absolute inset-4 grid grid-cols-2 grid-rows-2 gap-1 opacity-20 pointer-events-none">
                        <div className="bg-green-500/20 rounded-tl-lg border border-green-500/30 flex items-start justify-start p-2 text-xs text-green-300 font-bold uppercase tracking-widest">Düşük Risk</div>
                        <div className="bg-yellow-500/20 rounded-tr-lg border border-yellow-500/30 flex items-start justify-end p-2 text-xs text-yellow-300 font-bold uppercase tracking-widest">Ayrıştırma Sorunu</div>
                        <div className="bg-blue-500/20 rounded-bl-lg border border-blue-500/30 flex items-end justify-start p-2 text-xs text-blue-300 font-bold uppercase tracking-widest">Operasyonel Yük</div>
                        <div className="bg-red-600/30 rounded-br-lg border border-red-500/50 flex items-end justify-end p-2 text-xs text-red-300 font-bold uppercase tracking-widest">KRİTİK BÖLGE</div>
                    </div>
                    <div className="absolute left-0 top-1/2 -rotate-90 text-[10px] text-slate-500 font-bold tracking-widest -ml-6 pointer-events-none">TIBBİ ATIK ORANI (%)</div>
                    <div className="absolute bottom-0 left-1/2 -translate-x-1/2 text-[10px] text-slate-500 font-bold tracking-widest mb-1 pointer-events-none">TOPLAM HACİM (KG)</div>
                    <div className="absolute inset-6">
                        {data.map((item, i) => {
                            const x = (item.total / maxVolume) * 100;
                            const y = item.medicalRatio; 
                            const isCritical = x > 50 && y > 50;
                            const hosp = hospitals.find(h => h.id === item.hospitalId);
                            const color = hosp ? hosp.color : '#94a3b8';

                            return (
                                <div key={item.id} className="absolute transition-all duration-500" style={{ left: `${Math.min(x, 98)}%`, bottom: `${Math.min(y, 98)}%` }}>
                                    <div 
                                        className={`w-3 h-3 -ml-1.5 -mt-1.5 rounded-full border border-white/20 cursor-pointer shadow-lg hover:scale-150 hover:z-50 group relative`}
                                        style={{ backgroundColor: color, boxShadow: isCritical ? `0 0 10px ${color}` : 'none' }}
                                    >
                                        {isCritical && <div className="absolute inset-0 rounded-full animate-ping opacity-75" style={{backgroundColor: color}}></div>}
                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max hidden group-hover:block z-50 pointer-events-none"><div className="bg-slate-900 text-white text-xs p-2 rounded shadow-xl border border-slate-600"><div className="font-bold border-b border-slate-700 pb-1 mb-1">{item.name}</div><div>Hacim: {item.total.toFixed(1)} kg</div><div className={`${item.medicalRatio > 50 ? 'text-red-400' : 'text-green-400'}`}>Tıbbi: %{item.medicalRatio.toFixed(0)}</div></div></div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        const RiskActionPanel = ({ data }) => {
            const targetRatio = 20; 
            const priceDiff = WASTE_TYPES[0].costPerKg - WASTE_TYPES[2].costPerKg; 
            const riskyUnits = data.map(u => {
                const excessRatio = Math.max(0, u.medicalRatio - targetRatio);
                const wastedWeight = u.total * (excessRatio / 100);
                const wastedCost = wastedWeight * priceDiff;
                let diagnosis = 'Normal';
                let action = '-';
                let color = 'text-green-400';
                if (u.medicalRatio > 50 && u.total > 10) { diagnosis = 'Sistematik Ayrıştırma Hatası'; action = 'Personel Eğitimi & Kutu Kontrolü'; color = 'text-red-400'; } 
                else if (u.medicalRatio > targetRatio && u.total > 50) { diagnosis = 'Yüksek Hacimli Kaçak'; action = 'Yerinde Denetim'; color = 'text-orange-400'; }
                return { ...u, wastedCost, excessRatio, diagnosis, action, color };
            }).filter(u => u.wastedCost > 50).sort((a,b) => b.wastedCost - a.wastedCost);
            const totalPotentialSavings = riskyUnits.reduce((acc, u) => acc + u.wastedCost, 0);

            return (
                <div className="mt-6 flex flex-col gap-4">
                    <div className="bg-gradient-to-r from-red-900/40 to-slate-900 border border-red-900/50 p-4 rounded-xl flex items-center justify-between">
                        <div className="flex items-center gap-4"><div className="bg-red-500/20 p-3 rounded-full"><Siren className="text-red-500" size={24}/></div><div><div className="text-xs text-red-200 uppercase font-bold">Toplam İyileştirme Fırsatı (Aylık Tahmini)</div><div className="text-2xl font-bold text-white">{totalPotentialSavings.toLocaleString('tr-TR', {style: 'currency', currency: 'TRY', maximumFractionDigits: 0})}</div><div className="text-[10px] text-red-300">* Yanlış ayrıştırılan tıbbi atıkların maliyeti</div></div></div>
                        <button className="bg-white text-red-900 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-50 transition-colors">Raporu İndir</button>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                        <div className="p-3 bg-slate-900/50 border-b border-slate-700 flex items-center gap-2"><ClipboardList size={16} className="text-blue-400"/><span className="text-xs font-bold text-slate-300 uppercase">Öncelikli Müdahale Listesi</span></div>
                        <table className="w-full text-left text-xs">
                            <thead className="bg-slate-900 text-slate-500 font-bold border-b border-slate-700"><tr><th className="p-3">Birim</th><th className="p-3">Risk Profili</th><th className="p-3">İsraf (TL)</th><th className="p-3">Önerilen Aksiyon</th><th className="p-3 text-right"></th></tr></thead>
                            <tbody className="divide-y divide-slate-700/50">
                                {riskyUnits.slice(0, 5).map(u => (
                                    <tr key={u.id} className="hover:bg-slate-700/20 transition-colors"><td className="p-3 font-bold text-slate-200">{u.name}</td><td className="p-3"><div className="flex flex-col"><span className={u.color}>{u.diagnosis}</span><span className="text-[9px] text-slate-500">Tıbbi Oran: %{u.medicalRatio.toFixed(0)}</span></div></td><td className="p-3 font-mono text-white">{u.wastedCost.toLocaleString('tr-TR', {maximumFractionDigits:0})} ₺</td><td className="p-3"><span className="bg-blue-900/30 text-blue-300 px-2 py-1 rounded border border-blue-900/50">{u.action}</span></td><td className="p-3 text-right"><button className="text-slate-400 hover:text-white"><ArrowUpRight size={16}/></button></td></tr>
                                ))}
                                {riskyUnits.length === 0 && <tr><td colSpan="5" className="p-6 text-center text-green-400 font-bold">Harika! Şu an kritik bir verimsizlik tespit edilmedi.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const CostTable = ({ data }) => {
            const totals = data.reduce((acc, u) => ({
                medical: acc.medical + (u.medicalCost || 0),
                hazardous: acc.hazardous + (u.hazardousCost || 0),
                domestic: acc.domestic + (u.domesticCost || 0),
                recycle: acc.recycle + (u.recycleCost || 0),
                total: acc.total + (u.totalCost || 0)
            }), { medical: 0, hazardous: 0, domestic: 0, recycle: 0, total: 0 });

            return (
                <div className="flex flex-col h-full">
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
                        <div className="bg-slate-900/50 p-3 rounded border border-slate-700">
                            <div className="text-[10px] text-slate-500 uppercase font-bold">Toplam Fatura</div>
                            <div className="text-xl font-bold text-white mt-1">{totals.total.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 })}</div>
                        </div>
                        <div className="bg-red-900/20 p-3 rounded border border-red-900/30">
                            <div className="text-[10px] text-red-400 uppercase font-bold">Tıbbi Maliyet</div>
                            <div className="text-lg font-bold text-red-300 mt-1">{totals.medical.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 })}</div>
                        </div>
                        <div className="bg-yellow-900/20 p-3 rounded border border-yellow-900/30">
                            <div className="text-[10px] text-yellow-400 uppercase font-bold">Tehlikeli M.</div>
                            <div className="text-lg font-bold text-yellow-300 mt-1">{totals.hazardous.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 })}</div>
                        </div>
                        <div className="bg-slate-700/20 p-3 rounded border border-slate-600/30">
                            <div className="text-[10px] text-slate-400 uppercase font-bold">Evsel Maliyet</div>
                            <div className="text-lg font-bold text-slate-300 mt-1">{totals.domestic.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 })}</div>
                        </div>
                        <div className="bg-blue-900/20 p-3 rounded border border-blue-900/30">
                            <div className="text-[10px] text-blue-400 uppercase font-bold">Geri Dönüşüm</div>
                            <div className="text-lg font-bold text-blue-300 mt-1">{totals.recycle.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 })}</div>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto border border-slate-700 rounded-lg">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-950 text-slate-400 text-xs uppercase sticky top-0 z-10">
                                <tr>
                                    <th className="p-3">Birim / Departman</th>
                                    <th className="p-3 text-right text-rose-400 bg-rose-900/10">Tıbbi (TL)</th>
                                    <th className="p-3 text-right text-amber-400 bg-amber-900/10">Tehlikeli (TL)</th>
                                    <th className="p-3 text-right text-slate-400 bg-slate-800/50">Evsel (TL)</th>
                                    <th className="p-3 text-right text-cyan-400 bg-cyan-900/10">Geri D. (TL)</th>
                                    <th className="p-3 text-right text-white font-bold bg-slate-800">Toplam (TL)</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700/50">
                                {data.sort((a,b) => b.totalCost - a.totalCost).map(u => (
                                    <tr key={u.id} className="hover:bg-slate-700/30 transition-colors group">
                                        <td className="p-3 font-medium text-slate-200 border-r border-slate-800">{u.name}</td>
                                        <td className="p-3 text-right font-mono text-rose-300/80 group-hover:text-rose-300 border-r border-slate-800/50">{(u.medicalCost || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} ₺</td>
                                        <td className="p-3 text-right font-mono text-amber-300/80 group-hover:text-amber-300 border-r border-slate-800/50">{(u.hazardousCost || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} ₺</td>
                                        <td className="p-3 text-right font-mono text-slate-400/80 group-hover:text-slate-300 border-r border-slate-800/50">{(u.domesticCost || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} ₺</td>
                                        <td className="p-3 text-right font-mono text-cyan-300/80 group-hover:text-cyan-300 border-r border-slate-800/50">{(u.recycleCost || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} ₺</td>
                                        <td className="p-3 text-right font-bold text-white bg-slate-800/30">{(u.totalCost || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} ₺</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const TimeAnalysisChart = ({ data }) => {
            const maxWeight = Math.max(...data.map(d => d.weight), 1);
            const peakHour = data.reduce((max, curr) => curr.weight > max.weight ? curr : max, {weight: 0});

            return (
                <div className="flex flex-col h-full bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <h4 className="text-white font-bold flex items-center gap-2"><Clock size={18} className="text-purple-400"/> Operasyonel Yoğunluk Haritası</h4>
                            <p className="text-xs text-slate-400 mt-1">24 Saatlik zaman dilimine göre atık toplama yoğunluğu.</p>
                        </div>
                        <div className="text-right">
                            <div className="text-xs text-slate-500 uppercase">En Yoğun Saat</div>
                            <div className="text-2xl font-bold text-purple-400">{peakHour.weight > 0 ? `${peakHour.hour}:00` : '--:--'}</div>
                            <div className="text-[10px] text-slate-400">{peakHour.weight > 0 ? `${peakHour.weight.toFixed(0)} kg işlem` : ''}</div>
                        </div>
                    </div>

                    <div className="flex-1 flex items-end gap-1 overflow-x-auto pb-2 px-2">
                        {data.map((d) => {
                            const intensity = d.weight / (maxWeight || 1);
                            let barColor = 'bg-slate-700'; 
                            if (intensity > 0.3) barColor = 'bg-indigo-500'; 
                            if (intensity > 0.7) barColor = 'bg-purple-500'; 
                            if (intensity > 0.9) barColor = 'bg-pink-500'; 

                            return (
                                <div key={d.hour} className="flex-1 min-w-[20px] h-full flex flex-col justify-end group relative">
                                    <div 
                                        className={`rounded-t w-full transition-all relative ${barColor} hover:opacity-80`}
                                        style={{ height: `${Math.max(intensity * 90, 5)}%` }}
                                    >
                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 bg-slate-900 text-white text-[10px] p-2 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-20 border border-slate-600 shadow-xl pointer-events-none">
                                            <span className="font-bold block text-center mb-1">{d.hour}:00 - {d.hour}:59</span>
                                            <div className="flex justify-between gap-3 text-slate-300"><span>Ağırlık:</span> <span className="text-white">{d.weight.toFixed(1)} kg</span></div>
                                            <div className="flex justify-between gap-3 text-slate-300"><span>İşlem:</span> <span className="text-white">{d.count} adet</span></div>
                                        </div>
                                    </div>
                                    <div className="text-[9px] text-slate-500 text-center mt-2 border-t border-slate-700/50 pt-1 group-hover:text-white transition-colors">
                                        {d.hour % 3 === 0 ? d.hour : ''}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    {/* Legend */}
                    <div className="flex justify-center gap-4 mt-2 text-[10px] text-slate-500">
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-slate-700"></span> Düşük</div>
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-indigo-500"></span> Orta</div>
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"></span> Yüksek</div>
                        <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-pink-500"></span> Kritik</div>
                    </div>
                </div>
            );
        };

        // --- 4. MOLEKÜLER BİLEŞENLER (Detay Panelleri) ---
        const HospitalBenchmarking = ({ records, settings, userRole, hospitalId }) => {
            const [timeRange, setTimeRange] = useState('month'); 
            const [customStart, setCustomStart] = useState('');
            const [customEnd, setCustomEnd] = useState('');
            const [expandedCard, setExpandedCard] = useState(null);

            const toggleExpand = (id) => {
                setExpandedCard(expandedCard === id ? null : id);
            };

            const filteredRecords = useMemo(() => {
                let start = new Date();
                let end = new Date();

                if (timeRange === 'custom' && customStart && customEnd) {
                    start = new Date(customStart);
                    end = new Date(customEnd);
                    end.setHours(23, 59, 59, 999);
                } else {
                    if (timeRange === 'day') start.setDate(end.getDate() - 1);
                    else if (timeRange === 'month') start.setMonth(end.getMonth() - 1);
                    else if (timeRange === '3months') start.setMonth(end.getMonth() - 3);
                    else if (timeRange === '6months') start.setMonth(end.getMonth() - 6);
                    else if (timeRange === 'year') start.setFullYear(end.getFullYear() - 1);
                }

                return records.filter(r => {
                    const rDate = new Date(r.timestampDate);
                    return r.status === 'COMPLETED' && rDate >= start && rDate <= end;
                });
            }, [records, timeRange, customStart, customEnd]);

            const hospitalStats = useMemo(() => {
                const stats = {};
                const visibleHospitals = userRole === 'manager' 
                    ? HOSPITALS.filter(h => h.id === hospitalId) 
                    : HOSPITALS;

                visibleHospitals.forEach(h => {
                    stats[h.id] = { 
                        ...h, 
                        totalWeight: 0,
                        wasteByCat: {}, 
                        wasteByCatType: {}, 
                        scoreBreakdown: { 
                            medicalImpact: 0, hazardousImpact: 0, domesticImpact: 0, recycleBonus: 0 
                        }
                    };
                    LOCATION_CATEGORIES.forEach(cat => {
                        stats[h.id].wasteByCat[cat.id] = 0;
                        stats[h.id].wasteByCatType[cat.id] = { medical: 0, hazardous: 0, domestic: 0, recycle: 0, total: 0 };
                    });
                });

                filteredRecords.forEach(r => {
                    if (stats[r.hospitalId]) {
                        const w = r.weight || 0;
                        stats[r.hospitalId].totalWeight += w;

                        const locName = r.location;
                        const mappedLoc = settings.locationMap.find(l => l.name === locName);
                        const catId = mappedLoc ? mappedLoc.category : 'other';
                        
                        if (stats[r.hospitalId].wasteByCatType[catId]) {
                             if(stats[r.hospitalId].wasteByCatType[catId][r.wasteType] !== undefined) {
                                 stats[r.hospitalId].wasteByCatType[catId][r.wasteType] += w;
                             }
                             stats[r.hospitalId].wasteByCatType[catId].total += w;
                        }
                    }
                });

                return Object.values(stats).map(h => {
                    let daysDiff = 30; 
                    if (timeRange === 'custom' && customStart && customEnd) {
                        const s = new Date(customStart);
                        const e = new Date(customEnd);
                        daysDiff = Math.max(1, (e - s) / (1000 * 60 * 60 * 24));
                    } else if (timeRange === 'day') daysDiff = 1;
                    else if (timeRange === '3months') daysDiff = 90;
                    else if (timeRange === '6months') daysDiff = 180;
                    else if (timeRange === 'year') daysDiff = 365;

                    const timeFactor = daysDiff / 30;
                    const coeffs = settings.coefficients[h.id] || {};
                    let totalLoadIndex = 0;
                    let loadCount = 0;

                    const catKPIs = LOCATION_CATEGORIES.map(cat => {
                        const typeBreakdown = h.wasteByCatType[cat.id];
                        const totalWaste = typeBreakdown.total;
                        const opData = (coeffs[cat.id] || 0) * timeFactor;
                        const kpiValue = opData > 0 ? totalWaste / opData : 0;
                        const ref = cat.wasteFactorRef;
                        
                        let impact = 0;
                        if (opData > 0) {
                            if (kpiValue <= ref) {
                                impact = 10 * (1 - (kpiValue / ref));
                                impact = Math.max(0, Math.min(20, impact)); 
                            } else {
                                impact = -10 * ((kpiValue / ref) - 1);
                                impact = Math.max(-20, Math.min(0, impact));
                            }
                            totalLoadIndex += (kpiValue/ref);
                            loadCount++;
                        }
                        
                        return { ...cat, totalWaste, opData, kpiValue, impact, typeBreakdown };
                    });
                    
                    totalLoadIndex = loadCount > 0 ? totalLoadIndex / loadCount : 0;

                    let score = 0;
                    if(loadCount > 0) {
                         score = 100 - ((totalLoadIndex - 0.5) * 40);
                    }
                    score = Math.max(0, Math.min(100, score));

                    h.scoreBreakdown.medicalImpact = (100-score) * 0.6;
                    h.scoreBreakdown.hazardousImpact = (100-score) * 0.3;
                    h.scoreBreakdown.domesticImpact = (100-score) * 0.1;
                    h.scoreBreakdown.recycleBonus = score > 90 ? 5 : 0;

                    return { ...h, efficiencyScore: score, catKPIs, totalLoadIndex, scoreBreakdown: h.scoreBreakdown }; 
                }).sort((a, b) => b.efficiencyScore - a.efficiencyScore);
            }, [filteredRecords, settings, timeRange, userRole, hospitalId, customStart, customEnd]);
            
            return (
                <div className="flex flex-col h-full space-y-6 overflow-y-auto pr-2">
                    <div className="flex flex-wrap items-center gap-2 bg-slate-800 p-2 rounded-lg border border-slate-700">
                        <div className="text-xs font-bold text-slate-400 ml-2 mr-2">Analiz Periyodu:</div>
                        <div className="flex gap-1">
                            {['day', 'month', '3months', '6months', 'year'].map(t => (
                                <button key={t} onClick={() => { setTimeRange(t); }} className={`px-3 py-1 text-xs rounded transition-colors ${timeRange === t ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700'}`}>
                                    {t === 'day' ? 'Günlük' : t === 'month' ? 'Aylık' : t === '3months' ? '3 Aylık' : t === '6months' ? '6 Aylık' : 'Yıllık'}
                                </button>
                            ))}
                            <button onClick={() => setTimeRange('custom')} className={`px-3 py-1 text-xs rounded transition-colors flex items-center gap-1 ${timeRange === 'custom' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700'}`}>
                                <Calendar size={14}/>
                            </button>
                        </div>
                        {timeRange === 'custom' && (
                            <div className="flex items-center gap-2 ml-2 animate-fade-in bg-slate-900 p-1 rounded border border-slate-600">
                                <input type="date" value={customStart} onChange={(e) => setCustomStart(e.target.value)} className="bg-transparent text-white text-xs p-1 focus:outline-none"/>
                                <span className="text-slate-500">-</span>
                                <input type="date" value={customEnd} onChange={(e) => setCustomEnd(e.target.value)} className="bg-transparent text-white text-xs p-1 focus:outline-none"/>
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 gap-4">
                        {hospitalStats.map((h, idx) => (
                            <div key={h.id} className={`bg-slate-800 rounded-xl border p-4 relative overflow-hidden transition-all duration-300 ${idx === 0 ? 'border-yellow-500/50 shadow-[0_0_20px_rgba(234,179,8,0.1)]' : 'border-slate-700'}`}>
                                {idx === 0 && <div className="absolute top-0 right-0 bg-yellow-500 text-black text-xs font-bold px-3 py-1 rounded-bl-lg flex items-center gap-1"><Trophy size={12}/> LİDER</div>}
                                
                                <div className="flex items-center gap-4 mb-4">
                                    <div className="w-1.5 h-12 rounded-full" style={{backgroundColor: h.color}}></div>
                                    <div className="flex-1">
                                        <h3 className="font-bold text-lg text-white flex items-center gap-2">{h.name} <span className="text-slate-500 text-xs font-normal">({h.icon})</span></h3>
                                        <div className="flex gap-4 mt-1">
                                            <div className="text-xs text-slate-400">Puan: <span className={`font-bold text-lg ${h.efficiencyScore > 80 ? 'text-green-400' : h.efficiencyScore > 50 ? 'text-yellow-400' : 'text-red-400'}`}>{h.efficiencyScore.toFixed(0)}</span>/100</div>
                                            <div className="text-xs text-slate-400 mt-1">Atık Yükü Endeksi: <span className="text-blue-400 font-mono">{h.totalLoadIndex.toFixed(2)}</span></div>
                                        </div>
                                    </div>
                                    <button onClick={() => toggleExpand(h.id)} className="text-slate-400 hover:text-white p-2 bg-slate-700/50 rounded-lg">
                                         {expandedCard === h.id ? <ChevronUp size={18}/> : <ChevronDown size={18}/>}
                                    </button>
                                </div>
                                <div className="mt-2 h-1.5 w-full bg-slate-900 rounded-full overflow-hidden">
                                    <div className="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500" style={{width: `${h.efficiencyScore}%`}}></div>
                                </div>
                                {expandedCard === h.id && (
                                    <div className="mt-4 pt-4 border-t border-slate-700/50 animate-fade-in bg-slate-900/30 p-4 rounded-lg">
                                        <h4 className="text-xs font-bold text-slate-300 uppercase mb-3 flex items-center gap-2"><Info size={12}/> Detaylı Puan Karnesi</h4>
                                        <table className="w-full text-left text-xs">
                                            <thead className="text-slate-500 border-b border-slate-700"><tr><th className="pb-2">Mahal</th><th className="pb-2 text-right text-rose-400">Tıbbi (kg)</th><th className="pb-2 text-right text-amber-400">Tehlikeli</th><th className="pb-2 text-right text-slate-400">Evsel</th><th className="pb-2 text-right text-cyan-400">Geri D.</th><th className="pb-2 text-right text-white">Toplam</th><th className="pb-2 text-right">Op. Veri</th><th className="pb-2 text-right">KPI</th><th className="pb-2 text-right">Etki</th></tr></thead>
                                            <tbody className="divide-y divide-slate-700/50">
                                                {h.catKPIs.filter(c => c.opData > 0).map(cat => (
                                                    <tr key={cat.id}>
                                                        <td className="py-2 text-slate-300">{cat.label}</td>
                                                        <td className="py-2 text-right font-mono text-rose-300">{cat.typeBreakdown.medical.toFixed(1)}</td>
                                                        <td className="py-2 text-right font-mono text-amber-300">{cat.typeBreakdown.hazardous.toFixed(1)}</td>
                                                        <td className="py-2 text-right font-mono text-slate-400">{cat.typeBreakdown.domestic.toFixed(1)}</td>
                                                        <td className="py-2 text-right font-mono text-cyan-300">{cat.typeBreakdown.recycle.toFixed(1)}</td>
                                                        <td className="py-2 text-right font-mono font-bold text-white">{cat.totalWaste.toFixed(1)}</td>
                                                        <td className="py-2 text-right text-slate-500">{cat.opData.toFixed(0)}</td>
                                                        <td className="py-2 text-right font-bold text-white">{cat.kpiValue.toFixed(2)}</td>
                                                        <td className="py-2 text-right"><span className={`px-2 py-0.5 rounded ${cat.impact >= 0 ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>{cat.impact > 0 ? '+' : ''}{cat.impact.toFixed(1)}</span></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        <div className="mt-4 text-[10px] text-slate-500 italic text-center">* KPI = Toplam Atık / Operasyonel Veri. Puan Etkisi = Referans değerine göre sapma.</div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const IssueReportView = ({ issues, onBack }) => {
            return (
                <div className="flex flex-col h-full bg-slate-900 text-white p-6 animate-in fade-in zoom-in duration-300">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-4"><button onClick={onBack} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition-colors"><ArrowLeft size={20}/></button><div><h2 className="text-2xl font-bold flex items-center gap-2 text-red-400"><FileWarning /> SAHA UYGUNSUZLUK BİLDİRİMLERİ</h2><p className="text-xs text-slate-500">Personel tarafından raporlanan hatalı ayrıştırma ve uygunsuzluklar</p></div></div>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                         {issues.length === 0 ? (
                             <div className="flex flex-col items-center justify-center h-64 text-slate-500"><CheckCircle2 size={48} className="mb-2 text-green-500 opacity-50"/><p>Harika! Henüz bildirilmiş bir uygunsuzluk yok.</p></div>
                         ) : (
                             <div className="grid gap-4">
                                 {issues.map(issue => (
                                     <div key={issue.id} className="bg-slate-800 border border-slate-700 rounded-xl p-4 flex gap-4">
                                         <div className="w-24 h-24 bg-slate-900 rounded-lg flex items-center justify-center border border-slate-600 shrink-0 text-slate-500 text-xs text-center p-2">
                                             {issue.photo ? "FOTOĞRAF" : <Camera size={24}/>}
                                         </div>
                                         <div className="flex-1">
                                             <div className="flex justify-between items-start mb-2">
                                                 <div><div className="font-bold text-white text-sm">{issue.tagId || 'Barkodsuz Bildirim'}</div><div className="text-xs text-slate-400">{new Date(issue.timestamp).toLocaleString()}</div></div>
                                                 <span className={`text-[10px] px-2 py-1 rounded border font-bold uppercase ${issue.category === 'segregation' ? 'bg-red-900/50 text-red-200 border-red-800' : 'bg-orange-900/50 text-orange-200 border-orange-800'}`}>
                                                     {issue.category === 'segregation' ? 'HATALI AYRIŞTIRMA' : 'TEKNİK UYGUNSUZLUK'}
                                                 </span>
                                             </div>
                                             <p className="text-sm text-slate-300 bg-slate-900/50 p-3 rounded border border-slate-700/50 mb-2">{issue.description}</p>
                                             <div className="flex gap-2 text-xs text-slate-500 items-center"><UserCircle2 size={14}/> Raporlayan: {issue.reportedBy}</div>
                                         </div>
                                     </div>
                                 ))}
                             </div>
                         )}
                    </div>
                </div>
            );
        };

        const AdvancedComparison = ({ allStats, selectedUnits, toggleUnitSelection }) => {
            const [metric, setMetric] = useState('weight'); 
            const [wasteTypeFilter, setWasteTypeFilter] = useState('ALL'); 

            const sortedUnits = useMemo(() => {
                if(selectedUnits.length === 0) return [];
                const selected = allStats.filter(u => selectedUnits.includes(u.id));
                const getVal = (u) => {
                     let val = 0;
                     if (metric === 'weight') { val = wasteTypeFilter === 'ALL' ? u.total : (u[wasteTypeFilter] || 0); } 
                     else if (metric === 'cost') { val = wasteTypeFilter === 'ALL' ? u.totalCost : (u[`${wasteTypeFilter}Cost`] || 0); } 
                     else if (metric === 'efficiency') { val = u.medicalRatio; } 
                     else if (metric === 'volume') { val = u.count; }
                     return val;
                };
                return selected.sort((a,b) => getVal(b) - getVal(a));
            }, [allStats, selectedUnits, metric, wasteTypeFilter]);

            const getMetricLabel = () => {
                const typeLabel = wasteTypeFilter === 'ALL' ? 'Toplam' : WASTE_TYPES.find(t=>t.id===wasteTypeFilter)?.label;
                if (metric === 'weight') return `${typeLabel} Ağırlık (kg)`;
                if (metric === 'cost') return `${typeLabel} Maliyet (TL)`;
                if (metric === 'efficiency') return 'Tıbbi Atık Oranı (%) - Düşük İyidir';
                if (metric === 'volume') return 'İşlem Sayısı (Adet)';
            };

            const getValue = (u) => {
                 let val = 0;
                 if (metric === 'weight') {
                     if (wasteTypeFilter === 'ALL') val = u.total;
                     else val = u[wasteTypeFilter] || 0;
                 } else if (metric === 'cost') {
                     if (wasteTypeFilter === 'ALL') val = u.totalCost;
                     else val = u[`${wasteTypeFilter}Cost`] || 0;
                 } else if (metric === 'efficiency') {
                     val = u.medicalRatio;
                 } else if (metric === 'volume') {
                     val = u.count;
                 }
                 return val;
            };

            const formatValue = (val) => {
                 if (metric === 'weight') return val.toFixed(1) + ' kg';
                 if (metric === 'cost') return val.toLocaleString('tr-TR', {maximumFractionDigits: 0}) + ' ₺';
                 if (metric === 'efficiency') return val.toFixed(1) + '%';
                 if (metric === 'volume') return val + ' adet';
            };

            const TrendLine = ({ values, filter }) => {
                 const h = 40, w = 100;
                 if(!values || values.length < 2) return null;
                 const max = Math.max(...values.map(v => v.w));
                 const min = Math.min(...values.map(v => v.w));
                 const points = values.slice(-7).map((v, i, arr) => { 
                     const x = (i / (arr.length - 1)) * w;
                     const y = h - ((v.w - min) / (max - min || 1)) * h;
                     return `${x},${y}`;
                 }).join(' ');
                 const trendColor = values[values.length-1].w > values[0].w ? '#f87171' : '#4ade80';
                 return (<svg width="100%" height="40" viewBox={`0 0 ${w} ${h}`} className="overflow-visible"><polyline fill="none" stroke={trendColor} strokeWidth="2" points={points} strokeLinecap="round" strokeLinejoin="round"/><circle cx={(values.length > 0 ? 1 : 0) * w} cy={h - ((values[values.length-1]?.w - min)/(max-min||1))*h} r="3" fill={trendColor} /></svg>)
            };

            return (
                <div className="flex h-full gap-6">
                    <div className="w-80 bg-slate-800/50 rounded-xl border border-slate-700 p-4 flex flex-col h-full overflow-y-auto">
                        <div className="mb-4">
                            <h4 className="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-2"><SlidersHorizontal size={14}/> Kıyaslama Metriği</h4>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => setMetric('weight')} className={`p-2 text-xs rounded border text-center transition-all ${metric === 'weight' ? 'bg-blue-600 border-blue-500 text-white' : 'border-slate-600 text-slate-400 hover:bg-slate-700'}`}>Ağırlık</button>
                                <button onClick={() => setMetric('cost')} className={`p-2 text-xs rounded border text-center transition-all ${metric === 'cost' ? 'bg-emerald-600 border-emerald-500 text-white' : 'border-slate-600 text-slate-400 hover:bg-slate-700'}`}>Maliyet</button>
                                <button onClick={() => setMetric('efficiency')} className={`p-2 text-xs rounded border text-center transition-all ${metric === 'efficiency' ? 'bg-purple-600 border-purple-500 text-white' : 'border-slate-600 text-slate-400 hover:bg-slate-700'}`}>Verimlilik</button>
                                <button onClick={() => setMetric('volume')} className={`p-2 text-xs rounded border text-center transition-all ${metric === 'volume' ? 'bg-orange-600 border-orange-500 text-white' : 'border-slate-600 text-slate-400 hover:bg-slate-700'}`}>Hacim</button>
                            </div>
                        </div>

                        {(metric === 'weight' || metric === 'cost') && (
                            <div className="mb-6 animate-fade-in">
                                <h4 className="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-2"><Filter size={14}/> Atık Türü Filtresi</h4>
                                <div className="space-y-1">
                                    <button onClick={() => setWasteTypeFilter('ALL')} className={`w-full text-left px-3 py-2 rounded text-xs flex justify-between items-center ${wasteTypeFilter === 'ALL' ? 'bg-slate-600 text-white font-bold' : 'text-slate-400 hover:bg-slate-700'}`}>Tümü <span className="w-2 h-2 rounded-full bg-slate-400"></span></button>
                                    <button onClick={() => setWasteTypeFilter('medical')} className={`w-full text-left px-3 py-2 rounded text-xs flex justify-between items-center ${wasteTypeFilter === 'medical' ? 'bg-rose-900/50 text-rose-300 font-bold border border-rose-800' : 'text-slate-400 hover:bg-slate-700'}`}>Tıbbi Atık <span className="w-2 h-2 rounded-full bg-rose-500"></span></button>
                                    <button onClick={() => setWasteTypeFilter('hazardous')} className={`w-full text-left px-3 py-2 rounded text-xs flex justify-between items-center ${wasteTypeFilter === 'hazardous' ? 'bg-amber-900/50 text-amber-300 font-bold border border-amber-800' : 'text-slate-400 hover:bg-slate-700'}`}>Tehlikeli Atık <span className="w-2 h-2 rounded-full bg-amber-500"></span></button>
                                    <button onClick={() => setWasteTypeFilter('domestic')} className={`w-full text-left px-3 py-2 rounded text-xs flex justify-between items-center ${wasteTypeFilter === 'domestic' ? 'bg-slate-700 text-slate-200 font-bold border border-slate-600' : 'text-slate-400 hover:bg-slate-700'}`}>Evsel Atık <span className="w-2 h-2 rounded-full bg-slate-500"></span></button>
                                    <button onClick={() => setWasteTypeFilter('recycle')} className={`w-full text-left px-3 py-2 rounded text-xs flex justify-between items-center ${wasteTypeFilter === 'recycle' ? 'bg-cyan-900/50 text-cyan-300 font-bold border border-cyan-800' : 'text-slate-400 hover:bg-slate-700'}`}>Geri Dönüşüm <span className="w-2 h-2 rounded-full bg-cyan-500"></span></button>
                                </div>
                            </div>
                        )}

                        <div className="mt-4">
                            <div className="flex justify-between items-center mb-2"><h4 className="text-xs font-bold text-slate-400 uppercase">Kıyaslama Listesi ({selectedUnits.length}/6)</h4>{selectedUnits.length > 0 && <button onClick={() => selectedUnits.forEach(u => toggleUnitSelection(u))} className="text-[10px] text-red-400 hover:text-red-300">Temizle</button>}</div>
                            <div className="space-y-1">
                                {allStats.filter(u => u.isHospital).map(u => (
                                     <button key={u.id} onClick={() => toggleUnitSelection(u.id)} className={`w-full text-left px-3 py-3 rounded text-xs flex justify-between items-center border transition-all ${selectedUnits.includes(u.id) ? 'bg-indigo-900/50 border-indigo-500 text-white shadow-md' : 'bg-slate-900/50 border-slate-700 text-indigo-300 hover:bg-slate-800'}`}><span className="truncate font-bold flex items-center gap-2"><Building size={12}/> {u.name}</span>{selectedUnits.includes(u.id) && <CheckCircle2 size={12} className="text-indigo-400"/>}</button>
                                ))}
                                <div className="h-px bg-slate-700 my-2"></div>
                                {allStats.filter(u => !u.isHospital).map(u => (
                                    <button key={u.id} onClick={() => toggleUnitSelection(u.id)} className={`w-full text-left px-3 py-2 rounded text-xs flex justify-between items-center border transition-all ${selectedUnits.includes(u.id) ? 'bg-slate-700 border-blue-500 text-white shadow-md' : 'bg-transparent border-transparent text-slate-400 hover:bg-slate-800'}`}><span className="truncate">{u.name}</span>{selectedUnits.includes(u.id) && <CheckCircle2 size={12} className="text-blue-400"/>}</button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col overflow-hidden">
                        {selectedUnits.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-700 rounded-xl"><GitCompare size={64} className="mb-4 opacity-50"/><p className="text-lg font-medium">Kıyaslama Modu</p><p className="text-sm">Analize başlamak için soldan hastane veya birim seçin.</p></div>
                        ) : (
                            <div className="h-full flex flex-col gap-6 overflow-y-auto pr-2">
                                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6 shadow-lg shrink-0">
                                    <h3 className="text-sm font-bold text-slate-300 mb-6 flex items-center gap-2 justify-between"><span className="flex items-center gap-2"><BarChart3 size={18}/> {getMetricLabel()}</span><span className="text-xs font-normal bg-slate-700 px-2 py-1 rounded text-slate-300">{wasteTypeFilter !== 'ALL' ? WASTE_TYPES.find(t=>t.id===wasteTypeFilter)?.label : 'Tüm Atıklar'}</span></h3>
                                    <div className="flex items-end justify-around h-48 gap-4">
                                        {sortedUnits.map((u, i) => {
                                            const val = getValue(u);
                                            const max = Math.max(...sortedUnits.map(unit => getValue(unit)));
                                            const h = max > 0 ? (val / max) * 100 : 0;
                                            let barColor = 'bg-blue-500';
                                            if (u.isHospital) barColor = 'bg-indigo-500'; 
                                            if (i === 0) barColor = metric === 'efficiency' ? 'bg-green-500' : 'bg-yellow-500'; 
                                            if (metric === 'cost' && i === 0) barColor = 'bg-red-500'; 

                                            return (
                                                <div key={u.id} className="flex-1 flex flex-col items-center h-full justify-end group">
                                                    <div className="mb-2 text-sm font-bold text-white opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">{formatValue(val)}</div>
                                                    <div className={`w-full max-w-[60px] rounded-t-lg transition-all duration-500 relative group-hover:shadow-[0_0_15px_rgba(255,255,255,0.2)] ${barColor}`} style={{height: `${Math.max(h, 2)}%`}}>{i === 0 && <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-yellow-400"><Trophy size={16}/></div>}</div>
                                                    <div className="mt-3 text-xs font-medium text-slate-400 truncate w-full text-center" title={u.name}>{u.name.replace('(TÜMÜ)', '')}</div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {sortedUnits.map((u, i) => (
                                        <div key={u.id} className={`bg-slate-800 rounded-xl border p-4 hover:border-slate-500 transition-colors relative overflow-hidden ${u.isHospital ? 'border-indigo-900/50 bg-indigo-900/10' : 'border-slate-700'}`}>
                                            <div className="flex justify-between items-start mb-4">
                                                <div><div className="text-xs text-slate-500 font-bold mb-1">#{i+1} SIRALAMA</div><h4 className="font-bold text-white text-sm truncate w-40" title={u.name}>{u.name.replace('(TÜMÜ)', '')} {u.isHospital && <span className="text-[9px] bg-indigo-600 px-1 rounded ml-1">HASTANE</span>}</h4></div>
                                                <div className={`px-2 py-1 rounded text-[10px] font-bold border ${u.medicalRatio > 30 ? 'bg-red-900/30 text-red-400 border-red-900' : 'bg-green-900/30 text-green-400 border-green-900'}`}>{u.medicalRatio > 30 ? 'YÜKSEK RİSK' : 'STABİL'}</div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div><div className="text-[10px] text-slate-500">Maliyet</div><div className="text-sm font-mono font-bold text-slate-200">{u.totalCost.toLocaleString('tr-TR', {maximumFractionDigits:0})}₺</div></div>
                                                <div><div className="text-[10px] text-slate-500">Tıbbi Oran</div><div className="text-sm font-mono font-bold text-slate-200">%{u.medicalRatio.toFixed(1)}</div></div>
                                            </div>
                                            <div><div className="text-[10px] text-slate-500 mb-1">Hacim Trendi (Genel)</div><TrendLine values={u.weights} /></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SettingsView = ({ settings, onUpdateSettings, onBack, userRole, hospitalId }) => {
            const [activeTab, setActiveTab] = useState('locations'); 
            const [localSettings, setLocalSettings] = useState(JSON.parse(JSON.stringify(settings)));

            const visibleHospitals = userRole === 'manager' 
                ? HOSPITALS.filter(h => h.id === hospitalId)
                : HOSPITALS;

            const handleSave = () => {
                onUpdateSettings(localSettings);
                alert("Ayarlar başarıyla kaydedildi ve hesaplamalar güncellendi.");
            };

            return (
                <div className="flex flex-col h-full bg-slate-900 text-white p-6 animate-in fade-in zoom-in duration-300">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-4"><button onClick={onBack} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition-colors"><ArrowLeft size={20}/></button><div><h2 className="text-2xl font-bold flex items-center gap-2 text-blue-400"><Settings /> SİSTEM YAPILANDIRMASI</h2><p className="text-xs text-slate-500">Mahal Kategorileri ve Performans Katsayıları</p></div></div>
                        <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold text-sm"><SaveIcon size={16}/> KAYDET</button>
                    </div>

                    <div className="flex gap-4 mb-6 border-b border-slate-800 pb-1">
                        <button onClick={() => setActiveTab('locations')} className={`pb-2 px-4 text-sm font-bold border-b-2 transition-colors ${activeTab === 'locations' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-500'}`}>Mahal Kategorizasyonu</button>
                        <button onClick={() => setActiveTab('coefficients')} className={`pb-2 px-4 text-sm font-bold border-b-2 transition-colors ${activeTab === 'coefficients' ? 'border-purple-500 text-purple-400' : 'border-transparent text-slate-500'}`}>Aylık Operasyonel Veriler</button>
                    </div>

                    <div className="flex-1 bg-slate-800 rounded-xl border border-slate-700 p-6 overflow-y-auto">
                        {activeTab === 'locations' && (
                            <div className="space-y-4">
                                <div className="text-sm text-slate-400 bg-slate-900/50 p-4 rounded border border-slate-700 mb-4"><span className="text-white font-bold">Nasıl Çalışır?</span> Her bir mahalin (Oda) hangi kategoriye ait olduğunu buradan belirlersiniz. Performans analizleri, odaların isimlerine göre değil, burada seçtiğiniz kategorilere (Örn: Yoğun Bakım) göre yapılır.</div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {localSettings.locationMap.map((loc, idx) => (
                                        <div key={idx} className="bg-slate-900 p-4 rounded-lg border border-slate-700 flex flex-col gap-3 shadow-sm">
                                            {/* 1. Okunan QR ile gelen tanımlama (En Üstte) */}
                                            <div>
                                                <span className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">QR Tanımlama (ID)</span>
                                                <div className="font-bold text-sm text-white flex items-center gap-2 mt-1">
                                                    <div className="bg-blue-500/20 p-1.5 rounded text-blue-400"><QrCode size={14}/></div>
                                                    {loc.name}
                                                </div>
                                            </div>

                                            {/* 2. Tür Seçimi */}
                                            <div>
                                                <span className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Mahal Türü</span>
                                                <select 
                                                    value={loc.category} 
                                                    onChange={(e) => { 
                                                        const newLocs = [...localSettings.locationMap]; 
                                                        newLocs[idx].category = e.target.value; 
                                                        setLocalSettings({...localSettings, locationMap: newLocs}); 
                                                    }} 
                                                    className="w-full bg-slate-950 border border-slate-600 text-slate-200 text-xs rounded p-2.5 mt-1 focus:outline-none focus:border-blue-500 transition-colors"
                                                >
                                                    {LOCATION_CATEGORIES.map(cat => (<option key={cat.id} value={cat.id}>{cat.label}</option>))}
                                                </select>
                                            </div>

                                            {/* 3. Tanımlama Detayı Elle Giriş (Yeni) */}
                                            <div>
                                                <span className="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Tanımlama Detayı</span>
                                                <input 
                                                    type="text" 
                                                    value={loc.customLabel || ''}
                                                    onChange={(e) => {
                                                        const newLocs = [...localSettings.locationMap];
                                                        newLocs[idx].customLabel = e.target.value;
                                                        setLocalSettings({...localSettings, locationMap: newLocs});
                                                    }}
                                                    placeholder="Örn: 3. Kat Koridor Sonu..."
                                                    className="w-full bg-slate-950 border border-slate-600 text-slate-200 text-xs rounded p-2.5 mt-1 focus:outline-none focus:border-blue-500 transition-colors placeholder:text-slate-600"
                                                />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {activeTab === 'coefficients' && (
                            <div className="space-y-6">
                                <div className="text-sm text-slate-400 bg-slate-900/50 p-4 rounded border border-slate-700 mb-4"><span className="text-white font-bold">Mühendislik Verisi:</span> "Birim Başına Atık" (kg/hasta, kg/ameliyat) hesaplayabilmek için hastanelerin aylık verilerini giriniz. Bu veriler HBYS'den veya istatistik biriminden alınmalıdır.</div>
                                {visibleHospitals.map(h => (
                                    <div key={h.id} className="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden">
                                        <div className="bg-slate-950 p-3 border-b border-slate-700 font-bold text-white flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor: h.color}}></div>{h.name} - Aylık Veriler</div>
                                        <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            {LOCATION_CATEGORIES.filter(c => c.unit !== 'Sabit').map(cat => (
                                                <div key={cat.id} className="flex flex-col gap-1">
                                                    <label className="text-xs text-slate-400 font-bold uppercase">{cat.label} ({cat.unit})</label>
                                                    <input type="number" className="bg-slate-800 border border-slate-600 rounded p-2 text-white font-mono focus:border-blue-500 focus:outline-none" value={localSettings.coefficients[h.id]?.[cat.id] || 0} onChange={(e) => { const val = parseInt(e.target.value) || 0; setLocalSettings({ ...localSettings, coefficients: { ...localSettings.coefficients, [h.id]: { ...localSettings.coefficients[h.id], [cat.id]: val } } }); }} />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AnalyticsView = ({ records, settings, onBack, onOpenSettings, userRole, hospitalId }) => {
            const [selectedHospital, setSelectedHospital] = useState(userRole === 'manager' ? hospitalId : 'ALL'); 
            const [viewMode, setViewMode] = useState('risk'); 

            // Hastane Bazlı Veri (Hospital League - KPI)
            const hospitalStats = useMemo(() => {
                const stats = {};
                const costsPerKg = { medical: 15, hazardous: 25, domestic: 2, recycle: -1 };

                HOSPITALS.forEach(h => {
                    stats[h.id] = { 
                        ...h, 
                        totalWeight: 0, medical: 0, totalCost: 0, medicalRatio: 0, 
                        efficiencyScore: 0,
                        wasteByCat: { or: 0, icu: 0, polyclinic: 0, service: 0 } // Kategori bazlı atık toplamları
                    };
                });

                records.filter(r => r.status === 'COMPLETED').forEach(r => {
                    if (stats[r.hospitalId]) {
                        const w = r.weight || 0;
                        stats[r.hospitalId].totalWeight += w;
                        if (r.wasteType === 'medical') stats[r.hospitalId].medical += w;
                        
                        let cost = 0;
                        if (r.wasteType === 'medical') cost = w * costsPerKg.medical;
                        if (r.wasteType === 'hazardous') cost = w * costsPerKg.hazardous;
                        if (r.wasteType === 'domestic') cost = w * costsPerKg.domestic;
                        if (r.wasteType === 'recycle') cost = w * costsPerKg.recycle;
                        stats[r.hospitalId].totalCost += cost;

                        const locName = r.location;
                        const mappedLoc = settings.locationMap.find(l => l.name === locName);
                        const catId = mappedLoc ? mappedLoc.category : 'other';
                        if (stats[r.hospitalId].wasteByCat[catId] !== undefined) {
                            stats[r.hospitalId].wasteByCat[catId] += w;
                        }
                    }
                });

                // Yönetici ise sadece kendi hastanesini filtrele
                let result = Object.values(stats);
                if (userRole === 'manager') {
                    result = result.filter(h => h.id === hospitalId);
                }

                return result.map(h => {
                    const ratio = h.totalWeight > 0 ? (h.medical / h.totalWeight) * 100 : 0;
                    
                    const coeffs = settings.coefficients[h.id];
                    const kpi_or = coeffs.or > 0 ? h.wasteByCat.or / coeffs.or : 0;
                    const kpi_icu = coeffs.icu > 0 ? h.wasteByCat.icu / coeffs.icu : 0;
                    const kpi_poly = coeffs.polyclinic > 0 ? h.wasteByCat.polyclinic / coeffs.polyclinic : 0;

                    // Composite Index
                    const or_norm = kpi_or / LOCATION_CATEGORIES.find(c=>c.id==='or').wasteFactorRef;
                    const icu_norm = kpi_icu / LOCATION_CATEGORIES.find(c=>c.id==='icu').wasteFactorRef;
                    const poly_norm = kpi_poly / LOCATION_CATEGORIES.find(c=>c.id==='polyclinic').wasteFactorRef;
                    const totalLoadIndex = (or_norm + icu_norm + poly_norm) / 3;

                    // Nihai Puan
                    const totalPenalty = h.scoreBreakdown?.medicalImpact || 0 + h.scoreBreakdown?.hazardousImpact || 0 + h.scoreBreakdown?.domesticImpact || 0;
                    const totalBonus = h.scoreBreakdown?.recycleBonus || 0;
                    
                    let rawScore = 100 - (totalPenalty * 0.5) + (totalBonus * 1);
                    
                    return { ...h, medicalRatio: ratio, efficiencyScore: Math.max(0, Math.min(100, rawScore)), kpi_or, kpi_icu, kpi_poly, totalLoadIndex };
                });
            }, [records, settings, userRole, hospitalId]);

            // Diğer analizler için veri hazırlığı
            const allComparisonData = useMemo(() => {
                const allRecords = records.filter(r => r.status === 'COMPLETED');
                const units = {};
                const hospitals = {};
                const costsPerKg = { medical: 15, hazardous: 25, domestic: 2, recycle: -1 };

                // Hastane verilerini hazırla (Yönetici ise sadece kendi hastanesi)
                const visibleHospitalsList = userRole === 'manager' ? HOSPITALS.filter(h => h.id === hospitalId) : HOSPITALS;

                visibleHospitalsList.forEach(h => {
                     hospitals[h.id] = { 
                        id: h.id, name: `${h.name} (TÜMÜ)`, isHospital: true, color: h.color,
                        total: 0, count: 0, weights: [], medical: 0, domestic: 0, hazardous: 0, recycle: 0,
                        medicalCost: 0, domesticCost: 0, hazardousCost: 0, recycleCost: 0, totalCost: 0, medicalRatio: 0
                     };
                });

                allRecords.forEach(r => {
                    if (userRole === 'manager' && r.hospitalId !== hospitalId) return;

                    const locStr = String(r.location || 'UNKNOWN');
                    const rawUnitName = locStr.split('-')[0]; 
                    const hospIcon = HOSPITALS.find(h=>h.id === r.hospitalId)?.icon || r.hospitalId;
                    const uniqueKey = `${hospIcon}-${rawUnitName}`; 
                    
                    if (!units[uniqueKey]) units[uniqueKey] = { 
                        id: uniqueKey, name: uniqueKey, hospitalId: r.hospitalId, 
                        total: 0, count: 0, weights: [], 
                        medical: 0, domestic: 0, hazardous: 0, recycle: 0,
                        medicalCost: 0, domesticCost: 0, hazardousCost: 0, recycleCost: 0, totalCost: 0
                    };
                    
                    const w = r.weight || 0;
                    const safeTime = r.timestampDate instanceof Date ? r.timestampDate.getTime() : 0;
                    
                    const processStats = (obj) => {
                        obj.total += w;
                        obj.count += 1;
                        obj.weights.push({ w, time: safeTime });
                        let cost = 0;
                        if (r.wasteType === 'medical') { obj.medical += w; cost = w * costsPerKg.medical; obj.medicalCost += cost; }
                        if (r.wasteType === 'hazardous') { obj.hazardous += w; cost = w * costsPerKg.hazardous; obj.hazardousCost += cost; }
                        if (r.wasteType === 'domestic') { obj.domestic += w; cost = w * costsPerKg.domestic; obj.domesticCost += cost; }
                        if (r.wasteType === 'recycle') { obj.recycle += w; cost = w * costsPerKg.recycle; obj.recycleCost += cost; }
                        obj.totalCost += cost;
                    };

                    processStats(units[uniqueKey]);
                    if (hospitals[r.hospitalId]) processStats(hospitals[r.hospitalId]);
                });

                const finalize = (obj) => {
                    obj.medicalRatio = obj.total > 0 ? (obj.medical / obj.total) * 100 : 0;
                    return obj;
                };

                const unitList = Object.values(units).map(finalize);
                const hospitalList = Object.values(hospitals).map(finalize);

                return [...hospitalList, ...unitList];
            }, [records, userRole, hospitalId]);

            // Risk Matrisi ve Diğerleri için UnitStats (Filtrelemeye duyarlı)
            const unitStats = useMemo(() => {
                 return allComparisonData.filter(u => {
                     if (u.isHospital) return false;
                     if (selectedHospital === 'ALL') return true;
                     return u.hospitalId === selectedHospital;
                 }).sort((a,b) => b.total - a.total);
            }, [allComparisonData, selectedHospital]);

            const timeData = useMemo(() => {
                const hours = Array(24).fill(0).map((_, i) => ({ hour: i, count: 0, weight: 0 }));
                records.forEach(r => {
                    if (userRole === 'manager' && r.hospitalId !== hospitalId) return;
                    if (selectedHospital !== 'ALL' && r.hospitalId !== selectedHospital) return;
                    if (r.status !== 'COMPLETED') return;

                    const d = new Date(r.timestampDate);
                    const h = d.getHours();
                    if (h >= 0 && h < 24) { hours[h].count += 1; hours[h].weight += (r.weight || 0); }
                });
                return hours;
            }, [records, userRole, hospitalId, selectedHospital]);

            const [selectedUnits, setSelectedUnits] = useState([]);
            const toggleUnitSelection = (unitId) => {
                if (selectedUnits.includes(unitId)) { setSelectedUnits(selectedUnits.filter(u => u !== unitId)); } 
                else { if (selectedUnits.length < 6) setSelectedUnits([...selectedUnits, unitId]); }
            };

            // EKLENEN KISIM: filteredRecords tanımı
            const filteredRecords = useMemo(() => {
                const targetHospital = userRole === 'manager' ? hospitalId : selectedHospital;
                if (targetHospital === 'ALL') return records;
                return records.filter(r => r.hospitalId === targetHospital);
            }, [records, selectedHospital, userRole, hospitalId]);

            return (
                <div className="flex flex-col h-full bg-slate-900 text-white p-6 animate-in fade-in zoom-in duration-300">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-4"><button onClick={onBack} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition-colors"><ArrowLeft size={20}/></button><div><h2 className="text-2xl font-bold flex items-center gap-2 text-blue-400"><Target /> STRATEJİK KARAR MERKEZİ</h2><p className="text-xs text-slate-500">Risk Haritası & Karşılaştırmalı Analiz</p></div></div>
                        <div className="flex bg-slate-800 rounded-lg p-1">
                             {userRole !== 'manager' && (
                                 <>
                                    <button onClick={() => { setSelectedHospital('ALL'); setSelectedUnits([]); }} className={`px-4 py-2 text-xs font-bold rounded transition-colors flex items-center gap-1 ${selectedHospital === 'ALL' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}><Globe size={14} /> TÜMÜ</button>
                                    {HOSPITALS.map(h => (<button key={h.id} onClick={() => { setSelectedHospital(h.id); setSelectedUnits([]); }} className={`px-4 py-2 text-xs font-bold rounded transition-colors ${selectedHospital === h.id ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>{h.name.split(' ')[0]}</button>))}
                                 </>
                             )}
                             {userRole === 'manager' && (
                                 <div className="px-4 py-2 text-xs font-bold text-white bg-blue-600 rounded cursor-default">{HOSPITALS.find(h=>h.id===hospitalId)?.name}</div>
                             )}
                        </div>
                    </div>
                    
                    <div className="flex gap-4 mb-6 border-b border-slate-800 pb-1 overflow-x-auto">
                        <button onClick={() => setViewMode('hospital_bench')} className={`pb-2 px-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${viewMode === 'hospital_bench' ? 'border-amber-500 text-amber-400' : 'border-transparent text-slate-500 hover:text-slate-300'}`}><Building size={16}/> HASTANE PERFORMANSI (KPI)</button>
                        <button onClick={() => setViewMode('risk')} className={`pb-2 px-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${viewMode === 'risk' ? 'border-red-500 text-red-400' : 'border-transparent text-slate-500 hover:text-slate-300'}`}><AlertOctagon size={16}/> RİSK MATRİSİ</button>
                        <button onClick={() => setViewMode('comparison')} className={`pb-2 px-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${viewMode === 'comparison' ? 'border-blue-500 text-blue-400' : 'border-transparent text-slate-500 hover:text-slate-300'}`}><GitCompare size={16}/> ÇAPRAZ KIYASLAMA</button>
                        <button onClick={() => setViewMode('cost')} className={`pb-2 px-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${viewMode === 'cost' ? 'border-emerald-500 text-emerald-400' : 'border-transparent text-slate-500 hover:text-slate-300'}`}><Banknote size={16}/> MALİYET ETKİSİ</button>
                        <button onClick={() => setViewMode('time')} className={`pb-2 px-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${viewMode === 'time' ? 'border-purple-500 text-purple-400' : 'border-transparent text-slate-500 hover:text-slate-300'}`}><Clock size={16}/> ZAMAN ANALİZİ</button>
                    </div>

                    <div className="flex-1 bg-slate-800 rounded-xl border border-slate-700 p-6 overflow-hidden flex flex-col relative">
                        {viewMode === 'hospital_bench' && <HospitalBenchmarking records={filteredRecords} settings={settings} userRole={userRole} hospitalId={hospitalId} />}
                        {viewMode === 'risk' && <div className="h-full flex flex-col overflow-y-auto pr-2"><div className="flex justify-between items-start mb-4 shrink-0"><div className="text-sm text-slate-400 max-w-lg"><span className="text-white font-bold">Nasıl Okunur?</span> Sağ üst köşedeki (Kırmızı) noktalar hem hacim hem risk açısından en tehlikeli birimlerdir. Acil müdahale gerektirir.</div><div className="flex gap-4 text-xs"><div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Kritik</div><div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-400"></span> Stabil</div></div></div><div className="shrink-0"><RiskMatrix data={unitStats} hospitals={HOSPITALS} /></div><RiskActionPanel data={unitStats} /></div>}
                        {viewMode === 'comparison' && <AdvancedComparison allStats={allComparisonData} selectedUnits={selectedUnits} toggleUnitSelection={toggleUnitSelection} />}
                        {viewMode === 'cost' && <CostTable data={unitStats} />}
                        {viewMode === 'time' && <TimeAnalysisChart data={timeData} />}
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [seeding, setSeeding] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [statusType, setStatusType] = useState('info'); 

            const handleSeedData = async () => {
                setSeeding(true);
                setStatusMsg('Veriler yerel hafızaya yazılıyor...');
                setStatusType('info');
                
                // MOCK VERİ ÜRETİMİ
                const LOCATIONS = [
                    'AMELIYATHANE-ODA1', 'AMELIYATHANE-ODA2', 'ACIL-TRIYAJ', 
                    'ACIL-MUDAHALE', 'LAB-BIYOKIMYA', 'POLIKLINIK-KBB', 
                    'YOGUNBAKIM-YB1', 'STERILIZASYON-1', 'OFIS-IDARI'
                ];

                try {
                    const newRecords = [];
                    for (let i = 0; i < 60; i++) {
                        const randomHosp = HOSPITALS[Math.floor(Math.random() * HOSPITALS.length)].id;
                        const randomType = WASTE_TYPES[Math.floor(Math.random() * WASTE_TYPES.length)];
                        const randomLoc = LOCATIONS[Math.floor(Math.random() * LOCATIONS.length)];
                        const isCompleted = Math.random() > 0.10; 
                        const randomWeight = isCompleted ? parseFloat((Math.random() * 20 + 0.5).toFixed(2)) : 0;
                        
                        const randomStaff = STAFF_MEMBERS[Math.floor(Math.random() * STAFF_MEMBERS.length)];
                        const randomTime = new Date();
                        randomTime.setDate(randomTime.getDate() - Math.floor(Math.random() * 3));
                        const hour = Math.floor(Math.random() * 24);
                        randomTime.setHours(hour, Math.floor(Math.random() * 60));

                        newRecords.push({
                            hospitalId: randomHosp,
                            location: randomLoc,
                            wasteType: randomType.id,
                            weight: randomWeight,
                            collectedBy: randomStaff.name,
                            staffId: randomStaff.id,
                            timestamp: randomTime, 
                            tagId: `SIM-${Math.random().toString(36).substr(2, 5).toUpperCase()}`,
                            status: isCompleted ? 'COMPLETED' : 'PENDING',
                            weighedAt: isCompleted ? randomTime : null,
                            isManualEntry: Math.random() > 0.9 
                        });
                    }
                    
                    MockDB.seedData(newRecords);
                    
                    setStatusType('success');
                    setStatusMsg('✅ Veri Hazır! Panele Yönlendiriliyorsunuz...');
                    
                    setTimeout(() => {
                        onLogin('hq', null);
                    }, 1000);

                } catch (error) {
                    console.error("Seed error:", error);
                    setStatusType('error');
                    setStatusMsg(`❌ Hata: ${error.message}`);
                    setSeeding(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border-t-4 border-blue-500 text-slate-800">
                        <h1 className="text-2xl font-bold mb-6 flex items-center gap-2">
                            <Trash2 className="text-green-600" />
                            Atık Takip Sistemi v3.0
                        </h1>
                        <div className="space-y-4">
                            <p className="text-sm text-slate-500 mb-2">Simülasyon Modu (Offline)</p>
                            <button 
                                onClick={() => onLogin('collector_pre', null)}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg flex items-center justify-center gap-3 transition-all font-bold"
                            >
                                <QrCode />
                                <span>Saha Personeli</span>
                            </button>
                            <button 
                                onClick={() => onLogin('manager_pre', null)}
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg flex items-center justify-center gap-3 transition-all font-bold"
                            >
                                <Briefcase />
                                <span>Hastane Yöneticisi</span>
                            </button>
                            <button 
                                onClick={() => onLogin('hq', null)}
                                className="w-full bg-slate-800 hover:bg-slate-900 text-white p-4 rounded-lg flex items-center justify-center gap-3 transition-all font-bold"
                            >
                                <Building2 />
                                <span>Genel Merkez (HQ)</span>
                            </button>

                            <div className="border-t pt-4 mt-6">
                                <button 
                                    onClick={handleSeedData}
                                    disabled={seeding}
                                    className={`w-full p-3 rounded-lg flex items-center justify-center gap-2 text-sm transition-all border font-bold ${seeding ? 'bg-slate-100 text-slate-400' : 'bg-slate-100 hover:bg-slate-200 text-slate-700 border-slate-300'}`}
                                >
                                    {seeding ? <Loader2 size={16} className="animate-spin"/> : <Database size={16}/>}
                                    <span>{seeding ? 'Veriler Yükleniyor...' : 'DEMO VERİSİ YÜKLE'}</span>
                                </button>
                                {statusMsg && (
                                    <div className={`mt-3 text-xs text-center p-2 rounded ${statusType === 'error' ? 'bg-red-50 text-red-600 border border-red-200' : statusType === 'success' ? 'bg-green-50 text-green-600 border border-green-200' : 'bg-blue-50 text-blue-600 border border-blue-200'}`}>{statusMsg}</div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CollectorSelectScreen = ({ onSelect }) => {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-100 p-4">
                    <div className="bg-white p-6 rounded-xl shadow-lg max-w-md w-full text-slate-800">
                        <h2 className="text-xl font-bold mb-2 flex items-center gap-2">
                            <Users className="text-blue-600"/> Personel Seçimi
                        </h2>
                        <div className="space-y-3">
                            {STAFF_MEMBERS.map(staff => (
                                <button key={staff.id} onClick={() => onSelect(staff)} className="w-full flex items-center justify-between p-4 bg-slate-50 hover:bg-blue-50 border border-slate-200 hover:border-blue-200 rounded-xl transition-all group">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-100 text-blue-600 p-2 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-colors"><UserCircle2 size={24}/></div>
                                        <div className="text-left"><div className="font-bold text-slate-700">{staff.name}</div><div className="text-xs text-slate-400">Vardiya: {staff.shift}</div></div>
                                    </div>
                                    <ChevronRight className="text-slate-300 group-hover:text-blue-500"/>
                                </button>
                            ))}
                        </div>
                        <div className="mt-6 pt-6 border-t border-slate-100 text-center"><button onClick={() => window.location.reload()} className="text-slate-400 text-sm hover:text-slate-600">Geri Dön</button></div>
                    </div>
                </div>
            );
        };
        
        const ManagerSelectScreen = ({ onSelect }) => {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 p-4">
                     <div className="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border-t-4 border-purple-500 text-slate-800">
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                            <Briefcase className="text-purple-600"/> Hastane Yönetici Girişi
                        </h2>
                        <p className="text-sm text-slate-500 mb-6">Yönetmek istediğiniz tesisi seçiniz:</p>
                        
                        <div className="space-y-3">
                            {HOSPITAL_MANAGERS.map(mgr => (
                                <button
                                    key={mgr.id}
                                    onClick={() => onSelect(mgr)}
                                    className="w-full flex items-center justify-between p-4 bg-slate-50 hover:bg-purple-50 border border-slate-200 hover:border-purple-200 rounded-xl transition-all group"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="bg-purple-100 text-purple-600 p-2 rounded-full group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                            <Building size={20}/>
                                        </div>
                                        <div className="text-left">
                                            <div className="font-bold text-slate-700">{mgr.name}</div>
                                            <div className="text-xs text-slate-400">{HOSPITALS.find(h=>h.id===mgr.hospitalId)?.name}</div>
                                        </div>
                                    </div>
                                    <ChevronRight className="text-slate-300 group-hover:text-purple-500"/>
                                </button>
                            ))}
                        </div>
                        <div className="mt-6 pt-6 border-t border-slate-100 text-center"><button onClick={() => window.location.reload()} className="text-slate-400 text-sm hover:text-slate-600">Geri Dön</button></div>
                    </div>
                </div>
            )
        };

        const CollectorInterface = ({ user, staffProfile, logout }) => {
            const [mode, setMode] = useState('menu'); 
            const [loading, setLoading] = useState(false);
            const [collectionStep, setCollectionStep] = useState('scan_loc'); 
            const [collectData, setCollectData] = useState({ loc: '', type: '', tagId: '' });
            const [weighStep, setWeighStep] = useState('scan_tag'); 
            const [weighData, setWeighData] = useState({ docId: '', tagId: '', weight: 0, loc: '', type: '' });
            const [isManualInput, setIsManualInput] = useState(false);
            const [issueData, setIssueData] = useState({ tagId: '', description: '' });
            const [issueTab, setIssueTab] = useState('segregation'); 

            const handleSelectTypeAndPrint = (typeId) => {
                setLoading(true);
                setTimeout(() => {
                    const tagId = `TAG-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
                    MockDB.addRecord({
                        hospitalId: 'H1',
                        location: collectData.loc,
                        wasteType: typeId,
                        weight: 0, 
                        collectedBy: staffProfile.name,
                        staffId: staffProfile.id,
                        tagId: tagId,
                        status: 'PENDING'
                    });
                    setCollectData(prev => ({ ...prev, type: typeId, tagId: tagId }));
                    setCollectionStep('printed');
                    setLoading(false);
                }, 800);
            };

            const handleScanTag = () => {
                setLoading(true);
                setTimeout(() => {
                    const records = MockDB.getRecords();
                    const pending = records.find(r => r.status === 'PENDING');
                    if (pending) {
                        setWeighData({ docId: pending.id, tagId: pending.tagId, loc: pending.location, type: pending.wasteType, weight: 0 });
                        setWeighStep('weigh_confirm');
                    } else {
                        alert("Sistemde bekleyen etiket bulunamadı.");
                    }
                    setLoading(false);
                }, 600);
            };

            const handleFinalizeWeight = () => {
                setLoading(true);
                setTimeout(() => {
                    MockDB.updateRecord(weighData.docId, {
                        weight: weighData.weight,
                        status: 'COMPLETED',
                        weighedAt: new Date(),
                        isManualEntry: isManualInput
                    });
                    setWeighStep('success');
                    setLoading(false);
                }, 600);
            };

            const handleScanIssueTag = () => {
                setLoading(true);
                setTimeout(() => {
                    setIssueData({ ...issueData, tagId: `TAG-${Math.random().toString(36).substr(2, 6).toUpperCase()}` });
                    setLoading(false);
                }, 600);
            };

            const handleSubmitIssue = () => {
                if(!issueData.tagId) return alert("Lütfen bir barkod okutunuz.");
                setLoading(true);
                setTimeout(() => {
                    MockDB.addIssue({
                        tagId: issueData.tagId,
                        description: issueData.description,
                        reportedBy: staffProfile.name,
                        photo: true,
                        category: issueTab 
                    });
                    alert("Uygunsuzluk bildirimi başarıyla gönderildi.");
                    setMode('menu');
                    setIssueData({ tagId: '', description: '' });
                    setLoading(false);
                }, 800);
            };

            if (mode === 'menu') {
                return (
                    <div className="h-screen bg-slate-100 flex flex-col text-slate-800 overflow-hidden">
                        <div className="bg-blue-800 text-white p-4 shadow-md flex justify-between items-center shrink-0">
                            <div><div className="font-bold text-lg">H1</div><div className="text-xs text-blue-200 flex items-center gap-1"><UserCircle2 size={12}/> {staffProfile.name}</div></div>
                            <button onClick={logout}><LogOut size={18}/></button>
                        </div>
                        <div className="flex-1 p-4 flex flex-col gap-3 justify-center max-w-md mx-auto w-full overflow-y-auto">
                            
                            <button onClick={() => setMode('collection')} className="bg-white p-5 rounded-2xl shadow-md border-l-8 border-blue-500 flex items-center gap-4 active:scale-95 transition-all hover:shadow-lg group">
                                <div className="bg-blue-100 p-3 rounded-full group-hover:bg-blue-200 transition-colors"><QrCode size={32} className="text-blue-600"/></div>
                                <div className="text-left flex-1">
                                    <h2 className="text-lg font-bold text-slate-800">1. SAHADA TOPLA</h2>
                                    <p className="text-xs text-slate-500">Oda oda karekod okutarak toplama</p>
                                </div>
                                <ChevronRight className="text-slate-300 group-hover:text-blue-500"/>
                            </button>

                            <button onClick={() => setMode('weighing')} className="bg-white p-5 rounded-2xl shadow-md border-l-8 border-green-500 flex items-center gap-4 active:scale-95 transition-all hover:shadow-lg group">
                                <div className="bg-green-100 p-3 rounded-full group-hover:bg-green-200 transition-colors"><Scale size={32} className="text-green-600"/></div>
                                <div className="text-left flex-1">
                                    <h2 className="text-lg font-bold text-slate-800">2. KANTAR / TARTIM</h2>
                                    <p className="text-xs text-slate-500">Depo tartım ve etiketleme</p>
                                </div>
                                <ChevronRight className="text-slate-300 group-hover:text-green-500"/>
                            </button>

                            <button onClick={() => setMode('report_issue')} className="bg-white p-5 rounded-2xl shadow-md border-l-8 border-red-500 flex items-center gap-4 active:scale-95 transition-all hover:shadow-lg group">
                                <div className="bg-red-100 p-3 rounded-full group-hover:bg-red-200 transition-colors"><AlertTriangle size={32} className="text-red-600"/></div>
                                <div className="text-left flex-1">
                                    <h2 className="text-lg font-bold text-slate-800">UYGUNSUZLUK BİLDİRİMİ</h2>
                                    <p className="text-xs text-slate-500">Hatalı ayrıştırma ve teknik sorunlar</p>
                                </div>
                                <ChevronRight className="text-slate-300 group-hover:text-red-500"/>
                            </button>

                        </div>
                        <div className="p-4 text-center text-[10px] text-slate-400 shrink-0">
                            WMS Saha Modülü v3.3
                        </div>
                    </div>
                );
            }

            if (mode === 'collection') {
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col text-slate-800">
                        <div className="bg-blue-600 text-white p-4 flex items-center gap-3 shadow-md sticky top-0 z-10"><button onClick={() => setMode('menu')}><ArrowLeft/></button><span className="font-bold">Saha Toplama Modu</span></div>
                        <div className="flex-1 p-4 max-w-md mx-auto w-full flex flex-col">
                            {collectionStep === 'scan_loc' && (
                                <div className="text-center space-y-6 flex-1 flex flex-col justify-center">
                                    <div className="bg-white p-8 rounded-full inline-block shadow-md"><QrCode size={64} className="text-blue-500"/></div><h2 className="text-xl font-bold">Lokasyon Okut</h2>
                                    <button onClick={() => { setCollectData({loc: 'AMELIYATHANE-1'}); setCollectionStep('select_type'); }} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><Camera size={20}/> KAMERA AÇ (Demo)</button>
                                </div>
                            )}
                            {collectionStep === 'select_type' && (
                                <div className="space-y-4 flex-1">
                                    <div className="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm flex justify-between items-center"><div><div className="text-xs text-gray-500">Şu an buradasınız:</div><div className="font-bold text-lg text-slate-800">{collectData.loc}</div></div></div>
                                    <div className="grid grid-cols-2 gap-3">{WASTE_TYPES.map(t => (<button key={t.id} onClick={() => handleSelectTypeAndPrint(t.id)} disabled={loading} className={`${t.color} text-white p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow hover:opacity-90 active:scale-95 transition-transform h-32`}><t.icon size={28}/> <span className="font-semibold text-center leading-tight">{t.label}</span></button>))}</div>
                                </div>
                            )}
                            {collectionStep === 'printed' && (
                                <div className="text-center space-y-6 flex-1 flex flex-col justify-center">
                                    <div className="bg-yellow-50 border-2 border-yellow-400 p-6 rounded-lg text-yellow-900 shadow-sm relative"><div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-400 text-white px-3 py-1 rounded-full text-xs font-bold shadow">YENİ ETİKET</div><QrCode size={48} className="mx-auto mb-2 opacity-80"/><div className="font-mono font-bold text-3xl tracking-wider">{collectData.tagId}</div><div className="text-sm mt-2 font-semibold">{collectData.loc}</div><div className="text-xs uppercase mt-1">{WASTE_TYPES.find(t=>t.id===collectData.type)?.label}</div></div>
                                    <div className="grid grid-cols-1 gap-3 w-full"><button onClick={() => setCollectionStep('select_type')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><Plus size={20}/> EVET, BAŞKA ATIK EKLE</button><button onClick={() => { setCollectionStep('scan_loc'); setCollectData({}); }} className="w-full bg-white text-slate-600 border border-slate-300 py-4 rounded-xl font-bold shadow-sm flex items-center justify-center gap-2"><ArrowRight size={20}/> HAYIR, ODAYI BİTİR</button></div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (mode === 'weighing') {
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col text-slate-800">
                        <div className="bg-green-700 text-white p-4 flex items-center gap-3"><button onClick={() => setMode('menu')}><ArrowLeft/></button><span className="font-bold">Kantar / Tartım Modu</span></div>
                        <div className="flex-1 p-4 max-w-md mx-auto w-full flex flex-col justify-center">
                            {weighStep === 'scan_tag' && (<div className="text-center space-y-6"><div className="bg-white p-8 rounded-full inline-block shadow-md"><ScanLine size={64} className="text-green-600"/></div><h2 className="text-xl font-bold">Poşet Etiketi Okut</h2><button onClick={handleScanTag} disabled={loading} className="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">{loading ? 'Aranıyor...' : 'BARKOD OKUT'}</button></div>)}
                            {weighStep === 'weigh_confirm' && (<div className="space-y-6"><div className="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500"><div className="text-xs text-gray-400">Bulunan Kayıt</div><div className="font-bold text-lg">{weighData.tagId}</div><div className="flex justify-between mt-2 text-sm"><span>{weighData.loc}</span><span className={`px-2 rounded text-white ${WASTE_TYPES.find(t=>t.id===weighData.type)?.color}`}>{WASTE_TYPES.find(t=>t.id===weighData.type)?.label}</span></div></div><div className="relative">{isManualInput ? (<div className="bg-orange-50 p-4 rounded-lg border-2 border-orange-300"><input type="number" autoFocus className="w-full text-4xl font-mono p-2 rounded border border-orange-300 text-center" value={weighData.weight === 0 ? '' : weighData.weight} onChange={(e) => setWeighData({...weighData, weight: parseFloat(e.target.value) || 0})} placeholder="0.0" /></div>) : (<div className="bg-slate-800 text-green-400 font-mono text-4xl p-6 rounded-lg text-center relative">{weighData.weight > 0 ? `${weighData.weight} kg` : '00.00 kg'}</div>)}</div>{weighData.weight === 0 && !isManualInput ? (<div className="space-y-3"><button onClick={() => setTimeout(() => setWeighData(p=>({...p, weight:12.5})), 800)} disabled={loading} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><Scale/> TARTI VERİSİ AL</button><button onClick={() => setIsManualInput(true)} className="w-full text-slate-500 py-2 text-sm flex items-center justify-center gap-1 hover:text-slate-700"><Keyboard size={16}/> Manuel Gir</button></div>) : (<button onClick={handleFinalizeWeight} disabled={loading || weighData.weight <= 0} className="w-full py-4 rounded-xl font-bold shadow-lg bg-green-600 text-white flex items-center justify-center gap-2"><Save/> KAYDI TAMAMLA</button>)}</div>)}
                            {weighStep === 'success' && (<div className="text-center space-y-6 py-10"><CheckCircle2 size={80} className="text-green-500 mx-auto" /><h2 className="text-2xl font-bold text-gray-800">Kayıt Eşleştirildi!</h2><button onClick={() => setWeighStep('scan_tag')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg mt-4 flex items-center justify-center gap-2">SIRADAKİ POŞETİ OKUT</button></div>)}
                        </div>
                    </div>
                );
            }

            if (mode === 'report_issue') {
                return (
                    <div className="h-screen bg-gray-50 flex flex-col text-slate-800 overflow-hidden">
                         <div className="bg-red-600 text-white p-3 flex items-center gap-3 shrink-0 shadow-md z-10"><button onClick={() => setMode('menu')}><ArrowLeft/></button><span className="font-bold text-sm">Uygunsuzluk Bildirim Merkezi</span></div>
                         
                         {/* TAB BAR - Çizgiyi kaldırıp daha bütünleşik yapalım */}
                         <div className="flex bg-white border-b border-gray-200 shrink-0">
                             <button onClick={() => setIssueTab('segregation')} className={`flex-1 py-3 text-xs font-bold transition-colors ${issueTab === 'segregation' ? 'text-red-600 bg-red-50 border-b-2 border-red-600' : 'text-slate-400'}`}>⚠️ Hatalı Ayrıştırma</button>
                             <button onClick={() => setIssueTab('non_compliance')} className={`flex-1 py-3 text-xs font-bold transition-colors ${issueTab === 'non_compliance' ? 'text-orange-500 bg-orange-50 border-b-2 border-orange-500' : 'text-slate-400'}`}>🛠️ Teknik Uygunsuzluk</button>
                         </div>

                         <div className="flex-1 p-3 flex flex-col gap-3 max-w-md mx-auto w-full overflow-y-auto">
                            
                            {/* BARKOD ALANI - Daha kompakt */}
                            <div className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 shrink-0 flex flex-col items-center justify-center min-h-[100px]">
                                {issueData.tagId ? (
                                    <div className="w-full flex items-center justify-between">
                                        <div className="text-left">
                                            <div className="text-[10px] text-slate-400 uppercase tracking-wider">İşlem Barkodu</div>
                                            <div className="text-sm font-mono font-bold text-slate-800">{issueData.tagId}</div>
                                        </div>
                                        <div className="bg-green-100 text-green-600 p-2 rounded-full"><CheckCircle2 size={20}/></div>
                                    </div>
                                ) : (
                                    <>
                                        <ScanLine size={28} className="text-slate-300 mb-2"/>
                                        <button onClick={handleScanIssueTag} disabled={loading} className="w-full bg-slate-800 text-white py-2 rounded-md font-bold flex items-center justify-center gap-2 text-xs hover:bg-slate-700 transition-colors shadow">{loading ? 'Aranıyor...' : 'BARKODU OKUT'}</button>
                                        <p className="text-[9px] text-slate-400 mt-1">Poşet/varil üzerindeki etiketi okutun</p>
                                    </>
                                )}
                            </div>
                            
                            {/* HIZLI SEÇİM BUTONLARI */}
                            {issueTab === 'non_compliance' && (
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-slate-500 uppercase ml-1">Hızlı Seçim</label>
                                    <div className="grid grid-cols-3 gap-2">
                                        {['Delik Poşet', 'Ağır Yük', 'Kırık Varil', 'Etiket Yok', 'Kapak Yok', 'Sızıntı'].map(tag => (
                                            <button key={tag} onClick={() => setIssueData({...issueData, description: tag})} className={`border text-[10px] py-2 rounded transition-colors ${issueData.description === tag ? 'bg-orange-100 border-orange-400 text-orange-700 font-bold' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'}`}>{tag}</button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="space-y-1 flex-1 flex flex-col">
                                <label className="text-[10px] font-bold text-slate-500 uppercase ml-1">Açıklama</label>
                                <textarea 
                                    className={`w-full p-3 border rounded-lg outline-none text-xs resize-none focus:ring-1 flex-1 min-h-[80px] ${issueTab === 'segregation' ? 'focus:border-red-500 focus:ring-red-100' : 'focus:border-orange-500 focus:ring-orange-100'}`} 
                                    placeholder={issueTab === 'segregation' ? "Örn: Evsel kutusunda tıbbi atık..." : "Örn: Poşet yırtılmış..."}
                                    value={issueData.description} 
                                    onChange={(e) => setIssueData({...issueData, description: e.target.value})}
                                ></textarea>
                            </div>

                            <div className="grid grid-cols-4 gap-2">
                                <button className="col-span-1 py-3 border border-dashed border-slate-300 rounded-lg text-slate-400 flex flex-col items-center justify-center hover:bg-slate-50 transition-colors">
                                    <Camera size={18}/>
                                    <span className="text-[8px] mt-1">FOTO</span>
                                </button>
                                <button 
                                    onClick={handleSubmitIssue} 
                                    disabled={loading} 
                                    className={`col-span-3 text-white rounded-lg font-bold shadow-sm transition-colors text-xs flex items-center justify-center gap-2 ${issueTab === 'segregation' ? 'bg-red-600 hover:bg-red-700' : 'bg-orange-500 hover:bg-orange-600'}`}
                                >
                                    {loading ? <div className="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <SaveIcon size={16}/>}
                                    KAYDET VE BİLDİR
                                </button>
                            </div>
                         </div>
                    </div>
                );
            }
        };

        const DashboardInterface = ({ user, logout, userRole, hospitalId }) => {
            const [view, setView] = useState('overview'); 
            const [records, setRecords] = useState([]);
            const [issues, setIssues] = useState([]);
            const [settings, setSettings] = useState(MockDB.getData().settings);
            const [filterHospital, setFilterHospital] = useState(userRole === 'manager' ? hospitalId : 'ALL');

            useEffect(() => {
                const loadData = () => {
                    const dbData = MockDB.getData();
                    const processedRecords = dbData.records.map(r => ({ ...r, timestampDate: new Date(r.timestampDate) }));
                    setRecords(processedRecords);
                    setIssues(dbData.issues || []);
                    setSettings(dbData.settings);
                };
                loadData();
                const handleDbChange = () => loadData();
                window.addEventListener('db-change', handleDbChange);
                return () => window.removeEventListener('db-change', handleDbChange);
            }, []);

            const filteredRecords = useMemo(() => {
                const targetHospital = userRole === 'manager' ? hospitalId : filterHospital;
                if (targetHospital === 'ALL') return records;
                return records.filter(r => r.hospitalId === targetHospital);
            }, [records, filterHospital, userRole, hospitalId]);

            const stats = useMemo(() => {
                const s = { totalWeight: 0, completedCount: 0, pendingCount: 0, byType: WASTE_TYPES.map(t => ({ ...t, value: 0 })), byHospital: HOSPITALS.map(h => ({ ...h, value: 0 })), maxChartValue: 0, chartData: [] };
                filteredRecords.forEach(curr => {
                    if (curr.status === 'COMPLETED') {
                        const w = curr.weight || 0;
                        s.totalWeight += w;
                        s.completedCount += 1;
                        const typeIdx = s.byType.findIndex(t => t.id === curr.wasteType);
                        if (typeIdx > -1) s.byType[typeIdx].value += w;
                        const hospIdx = s.byHospital.findIndex(h => h.id === curr.hospitalId);
                        if (hospIdx > -1) s.byHospital[hospIdx].value += w;
                    } else { s.pendingCount += 1; }
                });
                if (userRole === 'manager') {
                     s.chartData = s.byHospital.filter(h => h.id === hospitalId).map(h => ({ label: h.name, value: h.value, color: 'bg-blue-500' }));
                } else if (filterHospital === 'ALL') { 
                    s.chartData = s.byHospital.map(h => ({ label: h.name.replace('Hastane ', 'H.'), value: h.value, color: 'bg-blue-500' })); 
                } else {
                     s.chartData = s.byHospital.filter(h => h.id === filterHospital).map(h => ({ label: h.name, value: h.value, color: 'bg-blue-500' }));
                }
                s.maxChartValue = Math.max(...s.chartData.map(d => d.value), 10);
                return s;
            }, [filteredRecords, filterHospital, userRole, hospitalId]);

            const handleUpdateSettings = (newSettings) => {
                MockDB.updateSettings(newSettings);
            };

            if (view === 'settings') return <SettingsView settings={settings} onUpdateSettings={handleUpdateSettings} onBack={() => setView('analytics')} userRole={userRole} hospitalId={hospitalId} />;
            if (view === 'analytics') return <AnalyticsView records={records} settings={settings} onBack={() => setView('overview')} onOpenSettings={() => setView('settings')} userRole={userRole} hospitalId={hospitalId} />;
            if (view === 'issues') return <IssueReportView issues={issues} onBack={() => setView('overview')} />;

            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 flex flex-col md:flex-row overflow-hidden font-sans">
                    <aside className="bg-slate-950 w-full md:w-64 flex-shrink-0 flex flex-col border-r border-slate-800">
                        <div className="p-6 border-b border-slate-800"><h1 className="text-xl font-bold flex items-center gap-2 text-blue-400"><LayoutDashboard /> WMS CORE</h1><p className="text-[10px] uppercase tracking-widest text-slate-500 mt-1">Komuta Merkezi ({userRole === 'manager' ? 'Yönetici' : 'HQ'})</p></div>
                        <div className="p-4 space-y-4 flex-1">
                            {userRole !== 'manager' && (
                                <>
                                    <div className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2"><Filter size={12}/> Tesis Filtresi</div>
                                    <button onClick={() => setFilterHospital('ALL')} className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all ${filterHospital === 'ALL' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}>Tüm Tesisler</button>
                                    {HOSPITALS.map(h => (<button key={h.id} onClick={() => setFilterHospital(h.id)} className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all ${filterHospital === h.id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800'}`}>{h.name}</button>))}
                                </>
                            )}
                            {userRole === 'manager' && (
                                <div className="p-3 bg-blue-900/20 rounded border border-blue-800 text-blue-300 text-sm">
                                    <div className="font-bold mb-1"><Building size={16} className="inline mr-1"/> Aktif Tesis</div>
                                    {HOSPITALS.find(h => h.id === hospitalId)?.name}
                                </div>
                            )}
                            <div className="border-t border-slate-800 my-4 pt-4 space-y-2">
                                <button onClick={() => setView('analytics')} className="w-full text-left px-4 py-3 rounded-lg text-sm font-medium bg-indigo-900/50 text-indigo-300 hover:bg-indigo-900 border border-indigo-800 flex items-center gap-2"><Microscope size={16}/> Detaylı Analiz & KPI</button>
                                <button onClick={() => setView('issues')} className="w-full text-left px-4 py-3 rounded-lg text-sm font-medium bg-red-900/20 text-red-300 hover:bg-red-900/40 border border-red-900/30 flex items-center gap-2"><AlertCircle size={16}/> Saha İhlal Bildirimleri</button>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-800 mt-auto">
                            <button onClick={() => setView('settings')} className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm w-full mb-3"><Settings2 size={16} /> Sistem Yapılandırma</button>
                            <button onClick={logout} className="flex items-center gap-2 text-red-400 hover:text-red-300 transition-colors text-sm w-full"><LogOut size={16} /> Çıkış Yap</button>
                        </div>
                    </aside>
                    <main className="flex-1 flex flex-col h-screen overflow-hidden">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 p-6 bg-slate-900 border-b border-slate-800 shrink-0">
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-slate-400 text-xs">TOPLAM ATIK</p><h3 className="text-2xl font-bold">{stats.totalWeight.toFixed(1)} kg</h3></div>
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-slate-400 text-xs">İŞLENEN</p><h3 className="text-2xl font-bold text-green-400">{stats.completedCount}</h3></div>
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-slate-400 text-xs">BEKLEYEN</p><h3 className="text-2xl font-bold text-orange-400">{stats.pendingCount}</h3></div>
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><p className="text-slate-400 text-xs">TIBBİ ORANI</p><h3 className="text-2xl font-bold text-red-400">{stats.totalWeight > 0 ? ((stats.byType.find(t=>t.id==='medical')?.value||0)/stats.totalWeight*100).toFixed(0) : 0}%</h3></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 flex flex-col gap-6">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 shrink-0 h-[320px]">
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-xl flex flex-col justify-center"><h3 className="text-sm font-bold text-slate-300 mb-2 flex items-center gap-2"><PieChart size={16} /> ATIK TÜRÜ DAĞILIMI</h3><div className="flex items-center justify-center flex-1"><SimpleDonutChart data={stats.byType} /></div></div>
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 shadow-xl flex flex-col"><h3 className="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2"><BarChart3 size={16} /> GENEL PERFORMANS</h3><div className="flex-1 flex items-end"><SimpleBarChart data={stats.chartData} maxVal={stats.maxChartValue} /></div></div>
                            </div>
                            <div className="bg-slate-800 rounded-xl border border-slate-700 shadow-xl flex flex-col flex-1 min-h-[400px] overflow-hidden">
                                <div className="p-4 border-b border-slate-700 bg-slate-800/50 backdrop-blur flex justify-between items-center"><h3 className="text-sm font-bold text-slate-300 flex items-center gap-2"><Activity size={16} className="text-green-500" /> CANLI OPERASYON AKIŞI</h3><button className="text-xs text-slate-500 hover:text-white"><MoreHorizontal size={16}/></button></div>
                                <div className="flex-1 overflow-y-auto p-0 scrollbar-thin scrollbar-thumb-slate-600">
                                    <table className="w-full text-left text-xs">
                                        <thead className="bg-slate-900/50 text-slate-500 uppercase font-bold sticky top-0 backdrop-blur">
                                            <tr><th className="p-3 pl-4">Durum</th><th className="p-3">Lokasyon</th><th className="p-3">Tür / Miktar</th><th className="p-3">Personel</th><th className="p-3 text-right pr-4">Zaman</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700/50">
                                            {filteredRecords.map(rec => (
                                                <tr key={rec.id} className="hover:bg-slate-700/30 transition-colors group">
                                                    <td className="p-3 pl-4"><div className={`flex items-center gap-2 ${rec.status === 'PENDING' ? 'text-orange-400' : 'text-green-400'}`}>{rec.status === 'PENDING' ? <Printer size={14}/> : <CheckCircle2 size={14}/>}<span className="font-bold">{rec.status === 'PENDING' ? 'Sahada' : 'Tamam'}</span></div></td>
                                                    <td className="p-3 font-medium text-slate-200">{rec.location}</td>
                                                    <td className="p-3"><div className="flex flex-col"><span className="text-slate-300">{WASTE_TYPES.find(t=>t.id===rec.wasteType)?.label}</span>{rec.weight > 0 && <span className="font-mono font-bold text-white">{rec.weight} kg</span>}</div></td>
                                                    <td className="p-3 text-slate-400">{rec.collectedBy || '---'}</td>
                                                    <td className="p-3 text-right pr-4 font-mono text-slate-500">{rec.timestampDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {filteredRecords.length === 0 && <div className="text-center text-slate-600 text-xs py-10">Veri akışı bekleniyor...</div>}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState({ uid: 'offline-user' }); 
            const [role, setRole] = useState(null);
            const [currentUserProfile, setCurrentUserProfile] = useState(null);
            const [managerHospitalId, setManagerHospitalId] = useState(null);

            const login = (r, p) => {
                if(r === 'collector_pre') setRole('collector_pre');
                else if (r === 'manager_pre') setRole('manager_pre');
                else if (r === 'manager') {
                     setRole('manager');
                     setManagerHospitalId(p.hospitalId);
                     setCurrentUserProfile(p);
                }
                else if(r === 'collector') { setRole('collector'); setCurrentUserProfile(p); }
                else setRole('hq');
            };

            const logout = () => {
                setRole(null);
                setCurrentUserProfile(null);
                setManagerHospitalId(null);
            };

            if (!role) return <LoginScreen onLogin={login} />;
            if (role === 'collector_pre') return <CollectorSelectScreen onSelect={(profile) => login('collector', profile)} />;
            if (role === 'manager_pre') return <ManagerSelectScreen onSelect={(profile) => login('manager', profile)} />;

            return role === 'collector' 
                ? <CollectorInterface user={user} staffProfile={currentUserProfile} logout={logout} />
                : <DashboardInterface user={user} logout={logout} userRole={role} hospitalId={managerHospitalId} />;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>